{% extends "base.html" %}
{% block title %}Batch Details — {{ batch.name }}{% endblock %}
{% block content %}

<div
  class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8"
>
  <div>
    <div class="flex items-center gap-3">
      <h1 class="text-2xl font-bold text-slate-800 tracking-tight">
        {{ batch.name }}
      </h1>
      <span
        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-100"
      >
        ID: {{ batch.id }}
      </span>
    </div>
    <p class="text-sm text-slate-500 mt-1">
      Manage students and communications for this batch.
    </p>
  </div>

  <div class="flex items-center gap-3">
    <a
      href="{{ url_for('batches.batches_page') }}"
      class="btn-secondary text-slate-600"
    >
      ← Back
    </a>
    <button
      id="open-send-all"
      class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-emerald-600 hover:bg-emerald-700 shadow-lg shadow-emerald-500/20 transition-all duration-200 hover:-translate-y-0.5 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500"
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"
        />
      </svg>
      Send to All
    </button>
  </div>
</div>

{# ---------- GLOW-STYLE CARD AROUND TABLE ---------- #}
<div
  class="relative group overflow-hidden rounded-2xl border border-slate-100 bg-white/90 p-0 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-transform transition-shadow transition-colors duration-300 w-full"
>
  <!-- Glow background -->
  <div
    class="pointer-events-none absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500"
  >
    <div
      class="absolute -top-16 -right-10 w-40 h-40 bg-emerald-400/22 blur-3xl"
    ></div>
    <div
      class="absolute -bottom-16 -left-10 w-40 h-40 bg-sky-400/20 blur-3xl"
    ></div>
  </div>

  <!-- Hover ring -->
  <div
    class="absolute inset-0 rounded-2xl border border-transparent group-hover:border-emerald-300 group-hover:shadow-[0_0_0_1px_rgba(59,130,246,0.45)] transition-all duration-300"
  ></div>

  <!-- Inner content -->
  <div class="relative z-10 rounded-2xl bg-white">
    <div class="overflow-x-auto rounded-2xl">
      <table class="min-w-full divide-y divide-slate-100">
        <thead class="bg-slate-50/90">
          <tr>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider"
            >
              Name
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider"
            >
              Email
            </th>
            <th scope="col" class="relative px-6 py-3">
              <span class="sr-only">Actions</span>
            </th>
          </tr>
        </thead>

        <tbody id="students-tbody" class="bg-white divide-y divide-slate-100">
          {% if students and students|length > 0 %}
            {% for s in students %}

          <tr
            class="group hover:bg-slate-50/90 transition-all duration-150"
            data-row-id="{{ s.id }}"
            data-name="{{ s.name }}"
            data-email="{{ s.email }}"
          >
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-slate-900 group-hover:text-emerald-600 transition-colors">
                {{ s.name }}
              </div>
            </td>

            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
              {{ s.email }}
            </td>

            <td
              class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"
            >
              <button
                class="inline-flex items-center px-3 py-1.5 border border-slate-300 shadow-sm text-xs font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 hover:text-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all"
                data-send="{{ s.id }}"
              >
                <span class="mr-1">Email</span>
                <svg
                  class="w-3 h-3 text-slate-500 group-hover:text-emerald-600 transition-colors"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"
                  />
                </svg>
              </button>
            </td>
          </tr>

            {% endfor %}
          {% else %}

          <tr>
            <td colspan="3" class="px-6 py-12 text-center text-slate-400">
              <div class="flex flex-col items-center gap-2">
                <svg
                  class="w-8 h-8 text-slate-300"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"
                  />
                </svg>
                <span class="font-medium">No students in this batch yet.</span>
              </div>
            </td>
          </tr>

          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<p id="status" class="text-xs text-slate-500 mt-3 text-right"></p>

  <!-- Loading overlay -->
  <div
    id="email-loading-overlay"
    class="fixed inset-0 z-[70] hidden bg-slate-900/40 backdrop-blur-sm items-center justify-center">
    <div class="bg-white/95 rounded-2xl shadow-xl border border-slate-200 px-6 py-5 flex items-center gap-4">
      <div class="h-9 w-9 rounded-full border-4 border-emerald-100 border-t-emerald-500 animate-spin"></div>
      <div class="text-left">
        <p class="text-sm font-semibold text-emerald-700">Processing your email…</p>
        <p class="text-xs text-slate-500 mt-1">This usually takes just a few seconds.</p>
      </div>
    </div>
  </div>

  <!-- Feedback popup -->
  <div
    id="email-feedback"
    class="fixed inset-0 z-[70] hidden bg-slate-900/40 backdrop-blur-sm items-center justify-center">
    <div
      id="email-feedback-card"
      class="bg-white rounded-2xl shadow-xl border px-6 py-6 max-w-sm w-full mx-4 flex items-start gap-4 min-h-[6rem]">
      <div id="email-feedback-icon" class="mt-0.5 shrink-0"></div>
      <div class="flex-1">
        <h3 id="email-feedback-title" class="text-sm font-semibold"></h3>
        <p id="email-feedback-message" class="mt-1 text-xs text-slate-600"></p>
        <div class="mt-3 flex justify-end">
          <button
            type="button"
            id="email-feedback-close"
            class="inline-flex items-center px-3 py-1.5 rounded-md text-xs font-medium
                   bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

{# ---------------- EMAIL MODAL ---------------- #}
<div
  id="email-modal"
  class="fixed inset-0 z-50 hidden"
  role="dialog"
  aria-modal="true"
>
  <div
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"
  ></div>

  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div
      class="flex min-h-full items-center justify-center p-4 text-center sm:p-0"
    >
      <div
        class="relative transform overflow-scroll rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-slate-200"
      >
        <div
          class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex items-center justify-between"
        >
          <h3
            class="text-base font-semibold leading-6 text-slate-800"
            id="email-modal-title"
          >
            Compose Email
          </h3>
          <button
            id="email-close"
            class="text-slate-400 hover:text-slate-600 rounded-md p-1 hover:bg-slate-200 transition-colors"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <form id="email-form" class="px-5 space-y-5">
          <input type="hidden" id="email-mode" value="single" />
          <input type="hidden" id="email-single-name" />
          <input type="hidden" id="email-single-email" />

          <div class="space-y-1.5">
            <label class="block text-sm font-medium text-slate-700">To</label>
            <input
              id="email-to"
              type="email"
              class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 py-2.5 sm:text-base"
              placeholder="student@example.com"
            />
            <div
              id="email-bulk-summary"
              class="hidden text-sm text-slate-600 bg-slate-50 p-2 rounded border border-slate-200"
            ></div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-1.5">
              <label class="block text-sm font-medium text-slate-700">CC</label>
              <input
                id="email-cc"
                type="text"
                class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 py-2.5 sm:text-base"
                placeholder="Optional"
              />
            </div>
            <div class="space-y-1.5">
              <label class="block text-sm font-medium text-slate-700"
                >BCC</label
              >
              <input
                id="email-bcc"
                type="text"
                class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 py-2.5 sm:text-base"
                placeholder="Optional"
              />
            </div>
          </div>

          <div class="space-y-1.5">
            <label class="block text-sm font-medium text-slate-700"
              >Subject</label
            >
            <input
              id="email-subject"
              type="text"
              class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 py-2.5 sm:text-base"
              placeholder="Enter subject line..."
            />
          </div>

          <div class="space-y-1.5">
            <label class="block text-sm font-medium text-slate-700"
              >AI Instructions</label
            >
            <textarea
              id="email-notes"
              rows="5"
              class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 py-2.5 sm:text-base"
              placeholder="Tell the AI what this email is about (e.g., 'Remind them about the quiz on Friday')..."
            ></textarea>
            <p class="text-xs text-slate-400">
              The AI will draft the full message based on these notes.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-1.5">
              <label class="block text-sm font-medium text-slate-700"
                >Tone</label
              >
              <select
                id="email-tone"
                class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 py-2.5 sm:text-base"
              >
                <option selected>Professional & Friendly</option>
                <option>Concise & Formal</option>
                <option>Warm & Encouraging</option>
                <option>Strict & Direct</option>
              </select>
            </div>

            <div class="space-y-1.5">
              <label class="block text-sm font-medium text-slate-700"
                >Action</label
              >
              <div class="flex items-center gap-4 mt-2">
                <label
                  class="inline-flex items-center gap-2 text-sm text-slate-700 cursor-pointer"
                >
                  <input
                    type="radio"
                    name="email-action"
                    value="send"
                    checked
                    class="text-emerald-600 focus:ring-emerald-500"
                  />
                  <span>Send Immediately</span>
                </label>
                <label
                  class="inline-flex items-center gap-2 text-sm text-slate-700 cursor-pointer"
                >
                  <input
                    type="radio"
                    name="email-action"
                    value="draft"
                    class="text-emerald-600 focus:ring-emerald-500"
                  />
                  <span>Save Draft</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Progress and Status Section -->
          <div id="email-status-section" class="pt-4 border-t border-slate-100">
            <div
              id="email-progress"
              class="hidden rounded-md bg-emerald-50 p-3 text-sm text-emerald-700 border border-emerald-100 flex items-center gap-2 mb-3"
            >
              <svg
                class="animate-spin h-4 w-4 text-emerald-600"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <span id="email-progress-text">Processing...</span>
            </div>

            <a id="email-view-drafts-btn" href="https://mail.google.com/mail/u/0/#drafts" target="_blank"
              class="hidden inline-flex items-center gap-1.5 text-sm font-medium text-emerald-600 hover:text-emerald-700 transition-colors mb-3">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
              </svg>
              <span class="underline">View Drafts in Gmail</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25" />
              </svg>
            </a>
          </div>

          <!-- Action Buttons -->
          <div
            class="flex items-center justify-end gap-3 pt-3"
          >
            <button type="button" id="email-cancel" class="btn-secondary">
              Cancel
            </button>
            <button type="submit" id="email-submit" class="btn-primary bg-emerald-600 hover:bg-emerald-700">
              Generate Preview
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Email Preview/Edit Modal -->
<div id="preview-modal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
  <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"></div>
  
  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
      <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-3xl border border-slate-200">
        <!-- Header -->
        <div class="bg-emerald-50 px-6 py-4 border-b border-emerald-100 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-emerald-900 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
            </svg>
            Review & Edit Email
          </h3>
          <button id="preview-close" class="text-slate-400 hover:text-slate-600 rounded-md p-1 hover:bg-emerald-100 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Email Preview/Edit Form -->
        <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
          <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4 flex items-start gap-3">
            <svg class="w-5 h-5 text-emerald-600 mt-0.5 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
            </svg>
            <div class="flex-1">
              <p class="text-sm text-emerald-900 font-medium">AI-Generated Email Preview</p>
              <p id="preview-info-text" class="text-xs text-emerald-700 mt-1">
                Feel free to edit the generated email. Your edited content will be used exactly as written.
              </p>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">To</label>
            <input id="preview-to" type="email" readonly
              class="block w-full rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-600" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Subject</label>
            <input id="preview-subject" type="text"
              class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/60" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Email Body</label>
            <textarea id="preview-body" rows="14"
              class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/60 resize-y font-mono"></textarea>
            <p class="mt-2 text-xs text-slate-500">
              <svg class="w-3 h-3 inline text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125" />
              </svg>
              This is the final email content that will be sent/saved.
            </p>
          </div>
        </div>

        <!-- Footer with Actions -->
        <div class="bg-slate-50 px-6 py-4 border-t border-slate-200">
          <div class="flex flex-col gap-3">
            <!-- Status and View Drafts Section -->
            <div id="preview-status-section">
              <div id="preview-status" class="text-sm font-medium text-emerald-600 mb-3 hidden"></div>
              <a id="preview-view-drafts" href="https://mail.google.com/mail/u/0/#drafts" target="_blank"
                class="hidden inline-flex items-center gap-1.5 text-sm font-medium text-emerald-600 hover:text-emerald-700 transition-colors mb-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                </svg>
                <span class="underline">View Drafts in Gmail</span>
                <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25" />
                </svg>
              </a>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-3 pt-3">
              <button type="button" id="preview-cancel"
                class="inline-flex items-center justify-center px-4 py-2 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                Cancel
              </button>
              <button type="button" id="preview-save-draft"
                class="inline-flex items-center justify-center px-4 py-2 border border-emerald-300 shadow-sm text-sm font-medium rounded-md text-emerald-700 bg-emerald-50 hover:bg-emerald-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M17 16v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-7a2 2 0 012-2h2m3-4H9a2 2 0 00-2 2v7a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-1m-1 4l-3 3m0 0l-3-3m3 3V3" />
                </svg>
                Save as Draft
              </button>
              <button type="button" id="preview-send"
                class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-emerald-600 hover:bg-emerald-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                </svg>
                Send Email
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tbody = document.getElementById("students-tbody");
    const statusEl = document.getElementById("status");

    // Modal logic
    const openSendAllBtn = document.getElementById("open-send-all");
    const modal = document.getElementById("email-modal");
    const closeBtn = document.getElementById("email-close");
    const cancelBtn = document.getElementById("email-cancel");
    const form = document.getElementById("email-form");
    const submitBtn = document.getElementById("email-submit");

    const modeEl = document.getElementById("email-mode");
    const singleNameEl = document.getElementById("email-single-name");
    const singleEmailEl = document.getElementById("email-single-email");

    const toInput = document.getElementById("email-to");
    const bulkSummary = document.getElementById("email-bulk-summary");
    const subjectEl = document.getElementById("email-subject");
    const notesEl = document.getElementById("email-notes");
    const toneEl = document.getElementById("email-tone");
    const ccEl = document.getElementById("email-cc");
    const bccEl = document.getElementById("email-bcc");
    const progressEl = document.getElementById("email-progress");
    const progressText = document.getElementById("email-progress-text");
    const titleEl = document.getElementById("email-modal-title");
    const viewDraftsBtn = document.getElementById("email-view-drafts-btn");

    const loadingOverlay = document.getElementById("email-loading-overlay");
    const feedback = document.getElementById("email-feedback");
    const feedbackCard = document.getElementById("email-feedback-card");
    const feedbackIcon = document.getElementById("email-feedback-icon");
    const feedbackTitle = document.getElementById("email-feedback-title");
    const feedbackMessage = document.getElementById("email-feedback-message");
    const feedbackClose = document.getElementById("email-feedback-close");

    // Preview modal elements
    const previewModal = document.getElementById("preview-modal");
    const previewClose = document.getElementById("preview-close");
    const previewCancel = document.getElementById("preview-cancel");
    const previewTo = document.getElementById("preview-to");
    const previewSubject = document.getElementById("preview-subject");
    const previewBody = document.getElementById("preview-body");
    const previewSaveDraft = document.getElementById("preview-save-draft");
    const previewSend = document.getElementById("preview-send");
    const previewStatus = document.getElementById("preview-status");
    const previewViewDrafts = document.getElementById("preview-view-drafts");
    const previewInfoText = document.getElementById("preview-info-text");

    // Store form data for later use
    let currentFormData = {
      cc: "",
      bcc: "",
      tone: "",
      mode: "single", // "single" or "bulk"
      bulkRecipients: [],
      bulkAction: "send",
      subject: "",
      notes: ""
    };

    function showLoading() {
      loadingOverlay.classList.remove("hidden");
      loadingOverlay.classList.add("flex");
    }
    function hideLoading() {
      loadingOverlay.classList.add("hidden");
      loadingOverlay.classList.remove("flex");
    }

    function closePreviewModal() {
      previewModal.classList.add("hidden");
      previewStatus.classList.add("hidden");
      previewViewDrafts.classList.add("hidden");
      
      // Reset mode and info text
      currentFormData.mode = "single";
      if (previewInfoText) {
        previewInfoText.textContent = "Feel free to edit the generated email. Your edited content will be used exactly as written.";
      }
    }

    previewClose?.addEventListener("click", closePreviewModal);
    previewCancel?.addEventListener("click", closePreviewModal);

    function showFeedback(type, title, message) {
      if (type === "success") {
        feedbackCard.className =
          "bg-white rounded-2xl shadow-xl border border-green-200 px-6 py-6 max-w-sm w-full mx-4 flex items-start gap-4 min-h-[6rem]";
        feedbackIcon.innerHTML =
          `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round"
                   d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg>`;
        feedbackTitle.className = "text-sm font-semibold text-green-800";
      } else {
        feedbackCard.className =
          "bg-white rounded-2xl shadow-xl border border-red-200 px-6 py-6 max-w-sm w-full mx-4 flex items-start gap-4 min-h-[6rem]";
        feedbackIcon.innerHTML =
          `<svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round"
                   d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg>`;
        feedbackTitle.className = "text-sm font-semibold text-red-800";
      }
      feedbackTitle.textContent = title;
      feedbackMessage.textContent = message;
      feedback.classList.remove("hidden");
      feedback.classList.add("flex");
    }

    function hideFeedback() {
      feedback.classList.add("hidden");
      feedback.classList.remove("flex");
    }

    if (feedbackClose) {
      feedbackClose.addEventListener("click", hideFeedback);
    }
    feedback?.addEventListener("click", (e) => {
      if (e.target === feedback) hideFeedback();
    });

    let bulkRecipients = [];

    function showModal() {
      modal.classList.remove("hidden");
    }
    function hideModal() {
      modal.classList.add("hidden");
    }

    function resetForm() {
      form.reset();
      subjectEl.value = "";
      notesEl.value = "";
      ccEl.value = "";
      bccEl.value = "";
      bulkRecipients = [];
      progressEl.classList.add("hidden");
      viewDraftsBtn?.classList.add("hidden");
    }

    function openEmailModalSingle(name, email) {
      resetForm();
      modeEl.value = "single";
      titleEl.textContent = `Compose Email — ${name || email}`;
      toInput.parentElement.classList.remove("hidden");
      toInput.value = email || "";
      bulkSummary.classList.add("hidden");
      singleNameEl.value = name || "";
      singleEmailEl.value = email || "";
      showModal();
      setTimeout(() => subjectEl.focus(), 50);
    }

    function openEmailModalBulk(list) {
      resetForm();
      modeEl.value = "bulk";
      titleEl.textContent = `Compose Email — Send to All (${list.length})`;
      toInput.parentElement.classList.add("hidden");
      bulkSummary.classList.remove("hidden");
      bulkSummary.textContent = list.map((x) => x.email).join(", ");
      bulkRecipients = list.slice();
      showModal();
      setTimeout(() => subjectEl.focus(), 50);
    }

    // Row email button
    tbody.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-send]");
      if (!btn) return;
      const row = btn.closest("tr");
      const name = row.getAttribute("data-name") || "";
      const email = row.getAttribute("data-email") || "";
      openEmailModalSingle(name, email);
    });

    // Send to all
    if (openSendAllBtn) {
      openSendAllBtn.addEventListener("click", () => {
        const rows = [...tbody.querySelectorAll("tr[data-row-id]")];
        const list = rows
          .map((r) => ({
            name: r.getAttribute("data-name") || "",
            email: r.getAttribute("data-email") || "",
          }))
          .filter((x) => x.email);

        if (!list.length) {
          statusEl.textContent = "No students to email.";
          return;
        }
        openEmailModalBulk(list);
      });
    }

    if (closeBtn) closeBtn.addEventListener("click", hideModal);
    if (cancelBtn) cancelBtn.addEventListener("click", hideModal);

    // Helper to send one
    async function sendOne(
      toEmail,
      name,
      subject,
      notes,
      tone,
      action,
      cc,
      bcc
    ) {
      const fd = new FormData();
      fd.set("to_email", toEmail);
      fd.set("subject", subject);
      fd.set("notes", notes);
      fd.set("tone", tone);
      fd.set("action", action);
      fd.set("cc", cc);
      fd.set("bcc", bcc);

      const res = await fetch("{{ url_for('email.email_compose') }}", {
        method: "POST",
        body: fd,
      });
      const ct = res.headers.get("Content-Type") || "";
      const data = ct.includes("application/json")
        ? await res.json()
        : { ok: res.ok, raw: await res.text() };
      if (!res.ok || !data.ok) {
        const who = name ? `${name} <${toEmail}>` : toEmail;
        throw new Error(
          data.error ? `${who}: ${data.error}` : `${who}: HTTP ${res.status}`
        );
      }
      return data;
    }

    // Submit Logic
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const tone = toneEl.value || "professional, friendly";
      const cc = ccEl.value || "";
      const bcc = bccEl.value || "";
      const subject = subjectEl.value || "";
      const notes = notesEl.value || "";

      // Store form data for preview modal use
      currentFormData.cc = cc;
      currentFormData.bcc = bcc;
      currentFormData.tone = tone;
      submitBtn.disabled = true;

      if (modeEl.value === "single") {
        const to = (toInput.value || singleEmailEl.value || "").trim();
        if (!to) {
          alert("Recipient email is required.");
          submitBtn.disabled = false;
          return;
        }

        showLoading();

        try {
          const fd = new FormData();
          fd.set("to_email", to);
          fd.set("subject", subject);
          fd.set("notes", notes);
          fd.set("tone", tone);
          fd.set("action", "draft"); // Always draft for preview
          fd.set("cc", cc);
          fd.set("bcc", bcc);

          const res = await fetch("{{ url_for('email.email_compose') }}", { method: "POST", body: fd });
          const json = await res.json().catch(() => ({ error: "Invalid response" }));

          hideLoading();

          if (res.ok && !json.error) {
            // Set mode to single
            currentFormData.mode = "single";
            
            // Populate preview modal
            previewTo.value = to;
            previewSubject.value = subject || json.subject || "";
            
            let emailBody = "";
            if (json.preview && json.preview.plain) {
              emailBody = json.preview.plain;
            } else if (json.body) {
              emailBody = json.body;
            } else if (json.content) {
              emailBody = json.content;
            } else if (json.message) {
              emailBody = json.message;
            }
            
            previewBody.value = emailBody;
            
            // Reset info text for single mode
            if (previewInfoText) {
              previewInfoText.textContent = "Feel free to edit the generated email. Your edited content will be used exactly as written.";
            }
            
            previewModal.classList.remove("hidden");
          } else {
            showFeedback("error", "Unable to generate preview", json.error || "Something went wrong.");
          }
        } catch (err) {
          hideLoading();
          showFeedback("error", "Network error", err.message || "Problem connecting to server.");
        } finally {
          submitBtn.disabled = false;
        }
        return;
      }

      // Bulk Mode - Generate preview first
      if (!bulkRecipients.length) {
        alert("No recipients");
        submitBtn.disabled = false;
        return;
      }

      const action = (
        form.querySelector('input[name="email-action"]:checked')?.value ||
        "send"
      ).toLowerCase();

      showLoading();

      try {
        // Generate preview using first recipient or generic email
        const fd = new FormData();
        fd.set("to_email", bulkRecipients[0].email || "preview@example.com");
        fd.set("subject", subject);
        fd.set("notes", notes);
        fd.set("tone", tone);
        fd.set("action", "draft"); // Always draft for preview
        fd.set("cc", cc);
        fd.set("bcc", bcc);

        const res = await fetch("{{ url_for('email.email_compose') }}", { method: "POST", body: fd });
        const json = await res.json().catch(() => ({ error: "Invalid response" }));

        hideLoading();

        if (res.ok && !json.error) {
          // Store bulk mode data for later use
          currentFormData.mode = "bulk";
          currentFormData.bulkRecipients = bulkRecipients.slice();
          currentFormData.bulkAction = action;
          currentFormData.subject = subject;
          currentFormData.notes = notes;

          // Populate preview modal
          previewTo.value = `${bulkRecipients.length} recipient${bulkRecipients.length > 1 ? 's' : ''}`;
          previewSubject.value = subject || json.subject || "";
          
          let emailBody = "";
          if (json.preview && json.preview.plain) {
            emailBody = json.preview.plain;
          } else if (json.body) {
            emailBody = json.body;
          } else if (json.content) {
            emailBody = json.content;
          } else if (json.message) {
            emailBody = json.message;
          }
          
          previewBody.value = emailBody;
          
          // Update info text for bulk mode
          if (previewInfoText) {
            previewInfoText.textContent = `This email will be sent to ${bulkRecipients.length} recipient${bulkRecipients.length > 1 ? 's' : ''}. Feel free to edit the content before sending.`;
          }
          
          // Close main modal and show preview
          hideModal();
          previewModal.classList.remove("hidden");
        } else {
          showFeedback("error", "Unable to generate preview", json.error || "Something went wrong.");
        }
      } catch (err) {
        hideLoading();
        showFeedback("error", "Network error", err.message || "Problem connecting to server.");
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Step 2: Save as Draft from preview modal
    previewSaveDraft.addEventListener("click", async () => {
      previewSaveDraft.disabled = true;
      previewSend.disabled = true;
      previewStatus.textContent = "Saving draft...";
      previewStatus.className = "text-sm font-medium text-emerald-600 animate-pulse";
      previewStatus.classList.remove("hidden");

      try {
        const editedContent = previewBody.value.trim();
        const editedSubject = previewSubject.value.trim();
        const instruction = `IMPORTANT: Use the following email content EXACTLY as written. Do not modify, rephrase, or regenerate. This is the final approved content:\n\n${editedContent}`;

        // Check if bulk mode or single mode
        if (currentFormData.mode === "bulk") {
          // Bulk mode: send to all recipients
          const recipients = currentFormData.bulkRecipients;
          let drafted = 0, failed = 0;
          previewStatus.textContent = `Creating drafts: 0/${recipients.length}`;

          for (let i = 0; i < recipients.length; i++) {
            const recipient = recipients[i];
            previewStatus.textContent = `Creating drafts: ${i + 1}/${recipients.length}`;

            const formData = new FormData();
            formData.append("to_email", recipient.email);
            formData.append("subject", editedSubject);
            formData.append("notes", instruction);
            formData.append("tone", "use exact content without any modifications");
            formData.append("action", "draft");
            formData.append("cc", currentFormData.cc);
            formData.append("bcc", currentFormData.bcc);

            try {
              const res = await fetch("{{ url_for('email.email_compose') }}", { method: "POST", body: formData });
              const json = await res.json().catch(() => ({ error: "Invalid response" }));
              if (res.ok && json.ok !== false) {
                drafted++;
              } else {
                failed++;
              }
            } catch (err) {
              failed++;
            }
          }

          previewStatus.textContent = `Success! ${drafted} draft${drafted > 1 ? 's' : ''} created in Gmail${failed > 0 ? `, ${failed} failed` : ''}.`;
          previewStatus.className = "text-sm font-medium text-green-600";
          previewViewDrafts.classList.remove("hidden");
        } else {
          // Single mode
          const formData = new FormData();
          formData.append("to_email", previewTo.value);
          formData.append("subject", editedSubject);
          formData.append("notes", instruction);
          formData.append("tone", "use exact content without any modifications");
          formData.append("action", "draft");
          formData.append("cc", currentFormData.cc);
          formData.append("bcc", currentFormData.bcc);

          const res = await fetch("{{ url_for('email.email_compose') }}", { method: "POST", body: formData });
          const json = await res.json().catch(() => ({ error: "Invalid response" }));

          if (res.ok && json.ok !== false) {
            previewStatus.textContent = "Draft saved successfully in Gmail!";
            previewStatus.className = "text-sm font-medium text-green-600";
            previewViewDrafts.classList.remove("hidden");
          } else {
            previewStatus.textContent = "Error: " + (json.error || "Failed to save draft");
            previewStatus.className = "text-sm font-medium text-red-600";
          }
        }
      } catch (err) {
        previewStatus.textContent = "Error: " + (err.message || "Network error");
        previewStatus.className = "text-sm font-medium text-red-600";
      } finally {
        previewSaveDraft.disabled = false;
        previewSend.disabled = false;
      }
    });

    // Step 3: Send from preview modal
    previewSend.addEventListener("click", async () => {
      previewSaveDraft.disabled = true;
      previewSend.disabled = true;
      previewStatus.textContent = "Sending email...";
      previewStatus.className = "text-sm font-medium text-emerald-600 animate-pulse";
      previewStatus.classList.remove("hidden");

      try {
        const editedContent = previewBody.value.trim();
        const editedSubject = previewSubject.value.trim();
        const instruction = `IMPORTANT: Use the following email content EXACTLY as written. Do not modify, rephrase, or regenerate. This is the final approved content:\n\n${editedContent}`;

        // Check if bulk mode or single mode
        if (currentFormData.mode === "bulk") {
          // Bulk mode: send to all recipients
          const recipients = currentFormData.bulkRecipients;
          let sent = 0, failed = 0;
          previewStatus.textContent = `Sending emails: 0/${recipients.length}`;

          for (let i = 0; i < recipients.length; i++) {
            const recipient = recipients[i];
            previewStatus.textContent = `Sending emails: ${i + 1}/${recipients.length}`;

            const formData = new FormData();
            formData.append("to_email", recipient.email);
            formData.append("subject", editedSubject);
            formData.append("notes", instruction);
            formData.append("tone", "use exact content without any modifications");
            formData.append("action", "send");
            formData.append("cc", currentFormData.cc);
            formData.append("bcc", currentFormData.bcc);

            try {
              const res = await fetch("{{ url_for('email.email_compose') }}", { method: "POST", body: formData });
              const json = await res.json().catch(() => ({ error: "Invalid response" }));
              if (res.ok && json.ok !== false) {
                sent++;
              } else {
                failed++;
              }
            } catch (err) {
              failed++;
            }
          }

          previewStatus.textContent = `Success! ${sent} email${sent > 1 ? 's' : ''} sent${failed > 0 ? `, ${failed} failed` : ''}.`;
          previewStatus.className = "text-sm font-medium text-green-600";
          setTimeout(() => {
            closePreviewModal();
            hideModal();
            form.reset();
          }, 2000);
        } else {
          // Single mode
          const formData = new FormData();
          formData.append("to_email", previewTo.value);
          formData.append("subject", editedSubject);
          formData.append("notes", instruction);
          formData.append("tone", "use exact content without any modifications");
          formData.append("action", "send");
          formData.append("cc", currentFormData.cc);
          formData.append("bcc", currentFormData.bcc);

          const res = await fetch("{{ url_for('email.email_compose') }}", { method: "POST", body: formData });
          const json = await res.json().catch(() => ({ error: "Invalid response" }));

          if (res.ok && json.ok !== false) {
            previewStatus.textContent = "Email sent successfully!";
            previewStatus.className = "text-sm font-medium text-green-600";
            setTimeout(() => {
              closePreviewModal();
              hideModal();
              form.reset();
            }, 1500);
          } else {
            previewStatus.textContent = "Error: " + (json.error || "Failed to send email");
            previewStatus.className = "text-sm font-medium text-red-600";
          }
        }
      } catch (err) {
        previewStatus.textContent = "Error: " + (err.message || "Network error");
        previewStatus.className = "text-sm font-medium text-red-600";
      } finally {
        previewSaveDraft.disabled = false;
        previewSend.disabled = false;
      }
    });
  });
</script>
{% endblock %}
