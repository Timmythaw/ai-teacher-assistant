{% extends "base.html" %}
{% block title %}Batch Details — {{ batch.name }}{% endblock %}
{% block content %}

<div
  class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8"
>
  <div>
    <div class="flex items-center gap-3">
      <h1 class="text-2xl font-bold text-slate-800 tracking-tight">
        {{ batch.name }}
      </h1>
      <span
        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100"
      >
        ID: {{ batch.id }}
      </span>
    </div>
    <p class="text-sm text-slate-500 mt-1">
      Manage students and communications for this batch.
    </p>
  </div>

  <div class="flex items-center gap-3">
    <a
      href="{{ url_for('batches.batches_page') }}"
      class="btn-secondary text-slate-600"
    >
      ← Back
    </a>
    <button
      id="open-send-all"
      class="btn-primary gap-2 shadow-md hover:-translate-y-0.5 hover:shadow-xl transition-all duration-200"
    >
      <svg
        class="w-4 h-4"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"
        />
      </svg>
      Send to All
    </button>
  </div>
</div>

{# ---------- GLOW-STYLE CARD AROUND TABLE ---------- #}
<div
  class="relative group overflow-hidden rounded-2xl border border-slate-100 bg-white/90 p-0 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-transform transition-shadow transition-colors duration-300 w-full"
>
  <!-- Glow background -->
  <div
    class="pointer-events-none absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500"
  >
    <div
      class="absolute -top-16 -right-10 w-40 h-40 bg-blue-400/22 blur-3xl"
    ></div>
    <div
      class="absolute -bottom-16 -left-10 w-40 h-40 bg-sky-400/20 blur-3xl"
    ></div>
  </div>

  <!-- Hover ring -->
  <div
    class="absolute inset-0 rounded-2xl border border-transparent group-hover:border-blue-300 group-hover:shadow-[0_0_0_1px_rgba(59,130,246,0.45)] transition-all duration-300"
  ></div>

  <!-- Inner content -->
  <div class="relative z-10 rounded-2xl bg-white">
    <div class="overflow-x-auto rounded-2xl">
      <table class="min-w-full divide-y divide-slate-100">
        <thead class="bg-slate-50/90">
          <tr>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider"
            >
              Name
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider"
            >
              Email
            </th>
            <th scope="col" class="relative px-6 py-3">
              <span class="sr-only">Actions</span>
            </th>
          </tr>
        </thead>

        <tbody id="students-tbody" class="bg-white divide-y divide-slate-100">
          {% if students and students|length > 0 %}
            {% for s in students %}

          <tr
            class="group hover:bg-slate-50/90 transition-all duration-150"
            data-row-id="{{ s.id }}"
            data-name="{{ s.name }}"
            data-email="{{ s.email }}"
          >
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-slate-900 group-hover:text-blue-600 transition-colors">
                {{ s.name }}
              </div>
            </td>

            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
              {{ s.email }}
            </td>

            <td
              class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"
            >
              <button
                class="inline-flex items-center px-3 py-1.5 border border-slate-300 shadow-sm text-xs font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 hover:text-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all"
                data-send="{{ s.id }}"
              >
                <span class="mr-1">Email</span>
                <svg
                  class="w-3 h-3 text-slate-500 group-hover:text-blue-600 transition-colors"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"
                  />
                </svg>
              </button>
            </td>
          </tr>

            {% endfor %}
          {% else %}

          <tr>
            <td colspan="3" class="px-6 py-12 text-center text-slate-400">
              <div class="flex flex-col items-center gap-2">
                <svg
                  class="w-8 h-8 text-slate-300"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"
                  />
                </svg>
                <span class="font-medium">No students in this batch yet.</span>
              </div>
            </td>
          </tr>

          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<p id="status" class="text-xs text-slate-500 mt-3 text-right"></p>

{# ---------------- EMAIL MODAL ---------------- #}
<div
  id="email-modal"
  class="fixed inset-0 z-50 hidden"
  role="dialog"
  aria-modal="true"
>
  <div
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"
  ></div>

  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div
      class="flex min-h-full items-center justify-center p-4 text-center sm:p-0"
    >
      <div
        class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-slate-200"
      >
        <div
          class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex items-center justify-between"
        >
          <h3
            class="text-base font-semibold leading-6 text-slate-800"
            id="email-modal-title"
          >
            Compose Email
          </h3>
          <button
            id="email-close"
            class="text-slate-400 hover:text-slate-600 rounded-md p-1 hover:bg-slate-200 transition-colors"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <form id="email-form" class="p-5 space-y-4">
          <input type="hidden" id="email-mode" value="single" />
          <input type="hidden" id="email-single-name" />
          <input type="hidden" id="email-single-email" />

          <div class="space-y-1.5">
            <label class="block text-sm font-medium text-slate-700">To</label>
            <input
              id="email-to"
              type="email"
              class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 py-2.5 sm:text-base"
              placeholder="student@example.com"
            />
            <div
              id="email-bulk-summary"
              class="hidden text-sm text-slate-600 bg-slate-50 p-2 rounded border border-slate-200"
            ></div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-1.5">
              <label class="block text-sm font-medium text-slate-700">CC</label>
              <input
                id="email-cc"
                type="text"
                class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 py-2.5 sm:text-base"
                placeholder="Optional"
              />
            </div>
            <div class="space-y-1.5">
              <label class="block text-sm font-medium text-slate-700"
                >BCC</label
              >
              <input
                id="email-bcc"
                type="text"
                class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 py-2.5 sm:text-base"
                placeholder="Optional"
              />
            </div>
          </div>

          <div class="space-y-1.5">
            <label class="block text-sm font-medium text-slate-700"
              >Subject</label
            >
            <input
              id="email-subject"
              type="text"
              class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 py-2.5 sm:text-base"
              placeholder="Enter subject line..."
            />
          </div>

          <div class="space-y-1.5">
            <label class="block text-sm font-medium text-slate-700"
              >AI Instructions</label
            >
            <textarea
              id="email-notes"
              rows="5"
              class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 py-2.5 sm:text-base"
              placeholder="Tell the AI what this email is about (e.g., 'Remind them about the quiz on Friday')..."
            ></textarea>
            <p class="text-xs text-slate-400">
              The AI will draft the full message based on these notes.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-1.5">
              <label class="block text-sm font-medium text-slate-700"
                >Tone</label
              >
              <select
                id="email-tone"
                class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 py-2.5 sm:text-base"
              >
                <option selected>Professional & Friendly</option>
                <option>Concise & Formal</option>
                <option>Warm & Encouraging</option>
                <option>Strict & Direct</option>
              </select>
            </div>

            <div class="space-y-1.5">
              <label class="block text-sm font-medium text-slate-700"
                >Action</label
              >
              <div class="flex items-center gap-4 mt-2">
                <label
                  class="inline-flex items-center gap-2 text-sm text-slate-700 cursor-pointer"
                >
                  <input
                    type="radio"
                    name="email-action"
                    value="send"
                    checked
                    class="text-brand-600 focus:ring-brand-500"
                  />
                  <span>Send Immediately</span>
                </label>
                <label
                  class="inline-flex items-center gap-2 text-sm text-slate-700 cursor-pointer"
                >
                  <input
                    type="radio"
                    name="email-action"
                    value="draft"
                    class="text-brand-600 focus:ring-brand-500"
                  />
                  <span>Save Draft</span>
                </label>
              </div>
            </div>
          </div>

          <div
            id="email-progress"
            class="hidden rounded-md bg-blue-50 p-3 text-sm text-blue-700 border border-blue-100 flex items-center gap-2"
          >
            <svg
              class="animate-spin h-4 w-4 text-brand-600"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            <span id="email-progress-text">Processing...</span>
          </div>

          <div
            class="mt-4 flex items-center justify-end gap-3 pt-4 border-t border-slate-100"
          >
            <button type="button" id="email-cancel" class="btn-secondary">
              Cancel
            </button>
            <button type="submit" id="email-submit" class="btn-primary">
              Generate & Send
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tbody = document.getElementById("students-tbody");
    const statusEl = document.getElementById("status");

    // Modal logic
    const openSendAllBtn = document.getElementById("open-send-all");
    const modal = document.getElementById("email-modal");
    const closeBtn = document.getElementById("email-close");
    const cancelBtn = document.getElementById("email-cancel");
    const form = document.getElementById("email-form");

    const modeEl = document.getElementById("email-mode");
    const singleNameEl = document.getElementById("email-single-name");
    const singleEmailEl = document.getElementById("email-single-email");

    const toInput = document.getElementById("email-to");
    const bulkSummary = document.getElementById("email-bulk-summary");
    const subjectEl = document.getElementById("email-subject");
    const notesEl = document.getElementById("email-notes");
    const toneEl = document.getElementById("email-tone");
    const ccEl = document.getElementById("email-cc");
    const bccEl = document.getElementById("email-bcc");
    const progressEl = document.getElementById("email-progress");
    const progressText = document.getElementById("email-progress-text");
    const titleEl = document.getElementById("email-modal-title");

    let bulkRecipients = [];

    function showModal() {
      modal.classList.remove("hidden");
    }
    function hideModal() {
      modal.classList.add("hidden");
    }

    function resetForm() {
      form.reset();
      subjectEl.value = "";
      notesEl.value = "";
      ccEl.value = "";
      bccEl.value = "";
      bulkRecipients = [];
      progressEl.classList.add("hidden");
    }

    function openEmailModalSingle(name, email) {
      resetForm();
      modeEl.value = "single";
      titleEl.textContent = `Compose Email — ${name || email}`;
      toInput.parentElement.classList.remove("hidden");
      toInput.value = email || "";
      bulkSummary.classList.add("hidden");
      singleNameEl.value = name || "";
      singleEmailEl.value = email || "";
      showModal();
      setTimeout(() => subjectEl.focus(), 50);
    }

    function openEmailModalBulk(list) {
      resetForm();
      modeEl.value = "bulk";
      titleEl.textContent = `Compose Email — Send to All (${list.length})`;
      toInput.parentElement.classList.add("hidden");
      bulkSummary.classList.remove("hidden");
      bulkSummary.textContent = list.map((x) => x.email).join(", ");
      bulkRecipients = list.slice();
      showModal();
      setTimeout(() => subjectEl.focus(), 50);
    }

    // Row email button
    tbody.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-send]");
      if (!btn) return;
      const row = btn.closest("tr");
      const name = row.getAttribute("data-name") || "";
      const email = row.getAttribute("data-email") || "";
      openEmailModalSingle(name, email);
    });

    // Send to all
    if (openSendAllBtn) {
      openSendAllBtn.addEventListener("click", () => {
        const rows = [...tbody.querySelectorAll("tr[data-row-id]")];
        const list = rows
          .map((r) => ({
            name: r.getAttribute("data-name") || "",
            email: r.getAttribute("data-email") || "",
          }))
          .filter((x) => x.email);

        if (!list.length) {
          statusEl.textContent = "No students to email.";
          return;
        }
        openEmailModalBulk(list);
      });
    }

    if (closeBtn) closeBtn.addEventListener("click", hideModal);
    if (cancelBtn) cancelBtn.addEventListener("click", hideModal);

    // Helper to send one
    async function sendOne(
      toEmail,
      name,
      subject,
      notes,
      tone,
      action,
      cc,
      bcc
    ) {
      const fd = new FormData();
      fd.set("to_email", toEmail);
      fd.set("subject", subject);
      fd.set("notes", notes);
      fd.set("tone", tone);
      fd.set("action", action);
      fd.set("cc", cc);
      fd.set("bcc", bcc);

      const res = await fetch("{{ url_for('email.email_compose') }}", {
        method: "POST",
        body: fd,
      });
      const ct = res.headers.get("Content-Type") || "";
      const data = ct.includes("application/json")
        ? await res.json()
        : { ok: res.ok, raw: await res.text() };
      if (!res.ok || !data.ok) {
        const who = name ? `${name} <${toEmail}>` : toEmail;
        throw new Error(
          data.error ? `${who}: ${data.error}` : `${who}: HTTP ${res.status}`
        );
      }
      return data;
    }

    // Submit Logic
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const tone = toneEl.value || "professional, friendly";
      const action = (
        form.querySelector('input[name="email-action"]:checked')?.value ||
        "send"
      ).toLowerCase();
      const cc = ccEl.value || "";
      const bcc = bccEl.value || "";
      const subject = subjectEl.value || "";
      const notes = notesEl.value || "";

      progressEl.classList.remove("hidden");

      if (modeEl.value === "single") {
        const to = (toInput.value || singleEmailEl.value || "").trim();
        if (!to) {
          alert("Recipient email is required.");
          progressEl.classList.add("hidden");
          return;
        }
        try {
          progressText.textContent = "Sending...";
          await sendOne(
            to,
            singleNameEl.value,
            subject,
            notes,
            tone,
            action,
            cc,
            bcc
          );
          progressText.textContent =
            action === "draft" ? "Draft created!" : "Email sent!";
          setTimeout(hideModal, 800);
        } catch (err) {
          progressText.textContent = "Failed: " + (err?.message || err);
        }
        return;
      }

      // Bulk
      if (!bulkRecipients.length) {
        alert("No recipients");
        progressEl.classList.add("hidden");
        return;
      }
      let ok = 0,
        fail = 0;
      for (let i = 0; i < bulkRecipients.length; i++) {
        const { name, email } = bulkRecipients[i];
        progressText.textContent = `Processing ${i + 1}/${
          bulkRecipients.length
        }...`;
        try {
          await sendOne(email, name, subject, notes, tone, action, cc, bcc);
          ok++;
        } catch (_) {
          fail++;
        }
      }
      progressText.textContent = `Done. Success: ${ok}, Failed: ${fail}.`;
    });
  });
</script>
{% endblock %}
