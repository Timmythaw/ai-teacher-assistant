{% extends "base.html" %} 
{% block title %}Assessment — {{ page_title }}{% endblock %} 

{% block content %}

<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
  <div>
    <h1 class="text-2xl font-bold text-slate-800 tracking-tight">{{ page_title }}</h1>
    <div class="flex items-center gap-3 mt-1.5 text-sm">
      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-600 border border-slate-200">
        ID: {{ assessment.id }}
      </span>
      
      {% if form_url %}
      <span class="text-slate-300">|</span>
      <a href="{{ form_url }}" target="_blank" class="flex items-center gap-1 text-emerald-600 hover:text-emerald-700 hover:underline font-medium transition-colors">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M7 11h10v2H7zM4 15h6v2H4zM4 7h16v2H4z"/>
          <path d="M22 2H2v20h20V2zm-2 18H4V4h16v16z"/>
        </svg>
        Open Google Form
      </a>
      {% else %}
      <span class="text-slate-300">|</span>
      <span class="flex items-center gap-1 text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded text-xs border border-emerald-100">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        No Form Linked
      </span>
      {% endif %}
    </div>
  </div>

  <a href="{{ url_for('assessments.list_assessments') }}"
     class="inline-flex items-center justify-center px-4 py-2 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-colors">
    ← Back to Assessments
  </a>
</div>

<!-- Gamified emerald card for responses -->
<div
  class="relative group overflow-hidden rounded-2xl border border-slate-100 bg-white/90
         shadow-sm hover:shadow-xl hover:-translate-y-1
         transition-transform transition-shadow transition-colors duration-300 w-full">

  <!-- Glow background -->
  <div class="pointer-events-none absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
    <div class="absolute -top-16 -right-10 w-40 h-40 bg-emerald-300/18 blur-3xl"></div>
    <div class="absolute -bottom-16 -left-10 w-40 h-40 bg-sky-300/18 blur-3xl"></div>
  </div>

  <!-- Hover ring -->
  <div
    class="absolute inset-0 rounded-2xl border border-transparent
           group-hover:border-emerald-300/80 group-hover:shadow-[0_0_0_1px_rgba(16,185,129,0.45)]
           transition-all duration-300">
  </div>

  <!-- Inner card content -->
  <div class="relative z-10 bg-white rounded-2xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-slate-800">Student Responses</h2>
      
      <button id="btn-fetch" 
        class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-emerald-500 hover:bg-emerald-600 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
        {% if not form_url and not form_id %}disabled{% endif %}>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
        </svg>
        Sync Results
      </button>
    </div>

    <div id="resp-state-container" class="space-y-4">
      <p id="resp-hint" class="text-sm text-slate-500 bg-slate-50 p-4 rounded-lg border border-slate-100 text-center">
        Click <span class="font-semibold text-slate-700">"Sync Results"</span> to fetch the latest submissions from Google Forms.
      </p>

      <div id="resp-summary" class="hidden text-sm font-medium text-emerald-600 bg-emerald-50 px-4 py-2 rounded-md border border-emerald-100">
      </div>

      <div id="table-wrap" class="hidden overflow-hidden rounded-lg border border-slate-200">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-100">
            <thead class="bg-slate-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Student Email</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Submitted</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Score</th>
                <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
              </tr>
            </thead>
            <tbody id="resp-tbody" class="bg-white divide-y divide-slate-100">
            </tbody>
          </table>
        </div>
      </div>

      <p id="resp-status" class="text-xs text-slate-400 text-right h-4"></p>
    </div>
  </div> <!-- inner responses card -->
</div>   <!-- gamified wrapper -->

<!-- Gamified emerald email modal -->
<div id="email-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
  <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"></div>
  
  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
      <div
        class="relative group overflow-hidden rounded-2xl bg-white/90 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-slate-100">
        
        <!-- Glow -->
        <div class="pointer-events-none absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
          <div class="absolute -top-16 -right-10 w-40 h-40 bg-emerald-300/20 blur-3xl"></div>
          <div class="absolute -bottom-16 -left-10 w-40 h-40 bg-sky-300/16 blur-3xl"></div>
        </div>

        <!-- Hover ring -->
        <div
          class="absolute inset-0 rounded-2xl border border-transparent
                 group-hover:border-emerald-300/80 group-hover:shadow-[0_0_0_1px_rgba(16,185,129,0.45)]
                 transition-all duration-300">
        </div>

        <!-- Inner modal content -->
        <div class="relative z-10 bg-white rounded-2xl">
          <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex items-center justify-between">
            <h3 class="text-base font-semibold leading-6 text-slate-800" id="email-modal-title">Compose Email</h3>
            <button id="email-close" class="text-slate-400 hover:text-slate-600 rounded-md p-1 hover:bg-slate-200 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <form id="email-form" class="p-6 space-y-4">
            <input type="hidden" id="email-student-name" />
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">To</label>
              <input id="email-to" type="email"
                class="block w-full rounded-md border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
                placeholder="student@example.com" required />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">CC</label>
                <input id="email-cc" type="text"
                  class="block w-full rounded-md border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
                  placeholder="Optional" />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">BCC</label>
                <input id="email-bcc" type="text"
                  class="block w-full rounded-md border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
                  placeholder="Optional" />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Subject</label>
              <input id="email-subject" type="text"
                class="block w-full rounded-md border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
                placeholder="e.g., Feedback on your assessment" required />
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Notes / Instructions</label>
              <textarea id="email-notes" rows="4"
                class="block w-full rounded-md border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm"
                placeholder="Tell the AI what to write..."></textarea>
              <p class="mt-1 text-xs text-slate-400">The AI will generate the email body based on these notes.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Tone</label>
                <select id="email-tone"
                  class="block w-full rounded-md border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm">
                  <option selected>Professional & Friendly</option>
                  <option>Concise & Formal</option>
                  <option>Warm & Encouraging</option>
                  <option>Strict & Direct</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Action</label>
                <div class="flex items-center gap-4 mt-2">
                  <label class="inline-flex items-center gap-2 text-sm text-slate-700 cursor-pointer">
                    <input type="radio" name="email-action" value="send" checked
                      class="text-emerald-600 focus:ring-emerald-500" />
                    <span>Send Now</span>
                  </label>
                  <label class="inline-flex items-center gap-2 text-sm text-slate-700 cursor-pointer">
                    <input type="radio" name="email-action" value="draft"
                      class="text-emerald-600 focus:ring-emerald-500" />
                    <span>Draft</span>
                  </label>
                </div>
              </div>
            </div>

            <div id="email-progress" class="hidden text-sm text-emerald-600 font-medium animate-pulse"></div>

            <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-100">
              <button type="button" id="email-cancel"
                class="inline-flex items-center justify-center px-4 py-2 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                Cancel
              </button>
              <button type="submit" id="email-submit"
                class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
                </svg>
                Generate Preview
              </button>
            </div>
          </form>
        </div> <!-- inner modal -->
      </div>   <!-- gamified modal wrapper -->
    </div>
  </div>
</div>

<!-- Email Preview/Edit Modal -->
<div id="preview-modal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
  <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"></div>
  
  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
      <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-3xl border border-slate-200">
        <!-- Header -->
        <div class="bg-emerald-50 px-6 py-4 border-b border-emerald-100 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-emerald-900 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
            </svg>
            Review & Edit Email
          </h3>
          <button id="preview-close" class="text-slate-400 hover:text-slate-600 rounded-md p-1 hover:bg-emerald-100 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Email Preview/Edit Form -->
        <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start gap-3">
            <svg class="w-5 h-5 text-blue-600 mt-0.5 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
            </svg>
            <div class="flex-1">
              <p class="text-sm text-blue-900 font-medium">AI-Generated Email Preview</p>
              <p class="text-xs text-blue-700 mt-1">
                Feel free to edit the generated email. Your edited content will be used exactly as written.
              </p>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">To</label>
            <input id="preview-to" type="email" readonly
              class="block w-full rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-600" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Subject</label>
            <input id="preview-subject" type="text"
              class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/60" />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Email Body</label>
            <textarea id="preview-body" rows="14"
              class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/60 resize-y font-mono"></textarea>
            <p class="mt-2 text-xs text-slate-500">
              <svg class="w-3 h-3 inline text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125" />
              </svg>
              This is the final email content that will be sent/saved.
            </p>
          </div>
        </div>

        <!-- Footer with Actions -->
        <div class="bg-slate-50 px-6 py-4 border-t border-slate-200">
          <div class="flex flex-col gap-3">
            <!-- Status and View Drafts Section -->
            <div id="preview-status-section">
              <div id="preview-status" class="text-sm font-medium text-emerald-600 mb-3 hidden"></div>
              <a id="preview-view-drafts" href="https://mail.google.com/mail/u/0/#drafts" target="_blank"
                class="hidden inline-flex items-center gap-1.5 text-sm font-medium text-emerald-600 hover:text-emerald-700 transition-colors mb-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                </svg>
                <span class="underline">View Drafts in Gmail</span>
                <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25" />
                </svg>
              </a>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-3 pt-3">
              <button type="button" id="preview-cancel"
                class="inline-flex items-center justify-center px-4 py-2 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                Cancel
              </button>
              <button type="button" id="preview-save-draft"
                class="inline-flex items-center justify-center px-4 py-2 border border-emerald-300 shadow-sm text-sm font-medium rounded-md text-emerald-700 bg-emerald-50 hover:bg-emerald-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M17 16v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-7a2 2 0 012-2h2m3-4H9a2 2 0 00-2 2v7a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-1m-1 4l-3 3m0 0l-3-3m3 3V3" />
                </svg>
                Save as Draft
              </button>
              <button type="button" id="preview-send"
                class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                </svg>
                Send Email
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} 

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btn-fetch");
    const tbody = document.getElementById("resp-tbody");
    const wrap = document.getElementById("table-wrap");
    const statusEl = document.getElementById("resp-status");
    const summaryEl = document.getElementById("resp-summary");
    const hintEl = document.getElementById("resp-hint");

    // Email Modal Elements
    const modal = document.getElementById("email-modal");
    const closeBtn = document.getElementById("email-close");
    const cancelBtn = document.getElementById("email-cancel");
    const form = document.getElementById("email-form");
    const nameEl = document.getElementById("email-student-name");
    const toEl = document.getElementById("email-to");
    const ccEl = document.getElementById("email-cc");
    const bccEl = document.getElementById("email-bcc");
    const subjectEl = document.getElementById("email-subject");
    const notesEl = document.getElementById("email-notes");
    const toneEl = document.getElementById("email-tone");
    const progressEl = document.getElementById("email-progress");

    // Preview modal elements
    const previewModal = document.getElementById("preview-modal");
    const previewClose = document.getElementById("preview-close");
    const previewCancel = document.getElementById("preview-cancel");
    const previewTo = document.getElementById("preview-to");
    const previewSubject = document.getElementById("preview-subject");
    const previewBody = document.getElementById("preview-body");
    const previewSaveDraft = document.getElementById("preview-save-draft");
    const previewSend = document.getElementById("preview-send");
    const previewStatus = document.getElementById("preview-status");
    const previewViewDrafts = document.getElementById("preview-view-drafts");

    let currentEmailData = null; // Store email metadata for sending

    // --- Modal Logic ---
    function openEmailModal(email, name) {
      form.reset();
      toEl.value = email || "";
      nameEl.value = name || "";
      subjectEl.value = "Regarding your recent assessment";
      modal.classList.remove("hidden");
      setTimeout(() => subjectEl.focus(), 50);
    }
    
    function closeEmailModal() {
      modal.classList.add("hidden");
    }

    if(closeBtn) closeBtn.addEventListener("click", closeEmailModal);
    if(cancelBtn) cancelBtn.addEventListener("click", closeEmailModal);
    if(previewClose) previewClose.addEventListener("click", closePreviewModal);
    if(previewCancel) previewCancel.addEventListener("click", closePreviewModal);
    
    // Close on backdrop click
    modal.addEventListener("click", (e) => {
      if (!e.target.closest('.bg-white')) {
        closeEmailModal();
      }
    });

    function closePreviewModal() {
      previewModal.classList.add("hidden");
      previewStatus.classList.add("hidden");
      previewViewDrafts.classList.add("hidden");
      currentEmailData = null;
    }

    // --- Email Preview Generation Logic ---
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const to = toEl.value.trim();
      const subject = subjectEl.value.trim();
      const notes = notesEl.value || "";
      const tone = toneEl.value || "professional, friendly";
      const action = (form.querySelector('input[name="email-action"]:checked')?.value || "send").toLowerCase();

      if (!to) return alert("Recipient email is required.");
      if (!subject) return alert("Subject is required.");

      try {
        progressEl.classList.remove("hidden");
        progressEl.textContent = "Generating preview...";
        progressEl.className = "text-sm font-medium text-emerald-600 animate-pulse block mb-2";
        
        // Generate AI preview
        const fd = new FormData();
        fd.set("to_email", to);
        fd.set("subject", subject);
        fd.set("notes", notes);
        fd.set("tone", tone);
        fd.set("action", "draft"); // Generate as preview
        fd.set("cc", ccEl.value || "");
        fd.set("bcc", bccEl.value || "");

        const res = await fetch("{{ url_for('email.email_compose') }}", {
          method: "POST",
          body: fd,
        });

        const ct = res.headers.get("Content-Type") || "";
        const data = ct.includes("application/json")
          ? await res.json()
          : { ok: res.ok, raw: await res.text() };

        if (!res.ok || !data.ok) {
          throw new Error(data.error || `HTTP ${res.status}`);
        }

        // Store email data for later use
        currentEmailData = {
          to: to,
          originalAction: action,
          tone: tone,
          cc: ccEl.value || "",
          bcc: bccEl.value || ""
        };

        // Extract email body
        let emailBody = "";
        if (data.preview && data.preview.plain) {
          emailBody = data.preview.plain;
        } else if (data.body) {
          emailBody = data.body;
        } else if (data.content) {
          emailBody = data.content;
        } else if (data.message) {
          emailBody = data.message;
        }

        // Populate preview modal
        previewTo.value = to;
        previewSubject.value = data.subject || subject;
        previewBody.value = emailBody;

        // Hide main modal and show preview
        closeEmailModal();
        previewModal.classList.remove("hidden");
      } catch (err) {
        progressEl.textContent = "Failed: " + (err?.message || err);
        progressEl.className = "text-sm font-medium text-red-600 block mb-2";
      } finally {
        progressEl.classList.add("hidden");
      }
    });

    // --- Fetch Responses Logic ---
    async function fetchResponses() {
      statusEl.textContent = "Syncing with Google Forms...";
      statusEl.className = "text-xs text-emerald-600 animate-pulse text-right h-4";
      
      const originalBtnText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Syncing...`;

      try {
        const url = "{{ url_for('assessments.api_assessment_responses', assessment_id=assessment.id) }}";
        const res = await fetch(url, { headers: { Accept: "application/json" } });
        const data = await res.json();
        
        if (!res.ok || !data.ok) throw new Error(data.error || `HTTP ${res.status}`);

        // Update Summary
        summaryEl.innerHTML = `<span class="font-bold">${data.num_responses}</span> response(s) fetched from "${data.form_title || "Form"}".`;
        summaryEl.classList.remove("hidden");
        hintEl.classList.add("hidden");

        // Clear and Rebuild Table
        tbody.innerHTML = "";
        const rows = Array.isArray(data.rows) ? data.rows : [];

        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-12 text-center text-slate-400">No responses found yet.</td></tr>`;
        } else {
          for (const r of rows) {
            let percent = r.percent;
            if ((percent == null || percent === "") && r.score != null && r.max_score) {
              const p = (Number(r.score) / Number(r.max_score)) * 100;
              if (isFinite(p)) percent = Math.round(p);
            }

            const isLow = typeof percent === "number" && percent < 50;
            const scoreText = r.fraction
              ? r.fraction 
              : r.score != null && r.max_score ? `${r.score}/${r.max_score}` 
              : r.score != null ? String(r.score) : "0";

            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-50 transition-colors duration-150 group";
            
            tr.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${escapeHtml(r.email || "Unknown")}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${escapeHtml(r.submitted || "-")}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${isLow ? 'bg-red-100 text-red-800' : 'bg-emerald-100 text-emerald-800'}">
                  ${escapeHtml(scoreText)}${typeof percent === "number" ? ` (${percent}%)` : ""}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button type="button" 
                    class="inline-flex items-center px-3 py-1.5 border border-slate-300 shadow-sm text-xs font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-colors"
                    data-email="${escapeAttr(r.email || "")}">
                    Send Email
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          }
        }

        wrap.classList.remove("hidden");
        statusEl.textContent = "Sync complete.";
        statusEl.className = "text-xs text-slate-400 text-right h-4";
        
      } catch (err) {
        statusEl.textContent = "Error: " + (err.message || err);
        statusEl.className = "text-xs text-red-500 text-right h-4";
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
      }
    }

    // Open email modal from table click
    tbody.addEventListener("click", (e) => {
      const button = e.target.closest("button[data-email]");
      if (!button) return;
      const email = button.getAttribute("data-email") || "";
      openEmailModal(email, email); 
    });

    function escapeHtml(s) {
      return (s || "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }
    function escapeAttr(s) {
      return (s || "").replaceAll('"', "&quot;");
    }

    if(btn) btn.addEventListener("click", fetchResponses);

    // Preview Modal - Save as Draft
    previewSaveDraft.addEventListener("click", async () => {
      if (!currentEmailData) return;

      previewSaveDraft.disabled = true;
      previewSend.disabled = true;
      previewStatus.textContent = "Saving draft...";
      previewStatus.className = "text-sm font-medium text-blue-600 animate-pulse";
      previewStatus.classList.remove("hidden");

      const editedSubject = previewSubject.value.trim();
      const editedBody = previewBody.value.trim();
      const exactContentInstruction = `IMPORTANT: Use the following email content EXACTLY as written. Do not modify, rephrase, or regenerate. This is the final approved content:\n\n${editedBody}`;

      try {
        const fd = new FormData();
        fd.set("to_email", currentEmailData.to);
        fd.set("subject", editedSubject);
        fd.set("notes", exactContentInstruction);
        fd.set("tone", "use exact content without any modifications");
        fd.set("action", "draft");
        fd.set("cc", currentEmailData.cc);
        fd.set("bcc", currentEmailData.bcc);

        const res = await fetch("{{ url_for('email.email_compose') }}", {
          method: "POST",
          body: fd,
        });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          throw new Error(data.error || "Failed to save draft");
        }

        previewStatus.textContent = "Draft saved successfully in Gmail!";
        previewStatus.className = "text-sm font-medium text-green-600";
        previewViewDrafts.classList.remove("hidden");
      } catch (err) {
        previewStatus.textContent = "Error: " + (err.message || err);
        previewStatus.className = "text-sm font-medium text-red-600";
      } finally {
        previewSaveDraft.disabled = false;
        previewSend.disabled = false;
      }
    });

    // Preview Modal - Send Email
    previewSend.addEventListener("click", async () => {
      if (!currentEmailData) return;

      previewSaveDraft.disabled = true;
      previewSend.disabled = true;
      previewStatus.textContent = "Sending email...";
      previewStatus.className = "text-sm font-medium text-blue-600 animate-pulse";
      previewStatus.classList.remove("hidden");

      const editedSubject = previewSubject.value.trim();
      const editedBody = previewBody.value.trim();
      const exactContentInstruction = `IMPORTANT: Use the following email content EXACTLY as written. Do not modify, rephrase, or regenerate. This is the final approved content:\n\n${editedBody}`;

      try {
        const fd = new FormData();
        fd.set("to_email", currentEmailData.to);
        fd.set("subject", editedSubject);
        fd.set("notes", exactContentInstruction);
        fd.set("tone", "use exact content without any modifications");
        fd.set("action", "send");
        fd.set("cc", currentEmailData.cc);
        fd.set("bcc", currentEmailData.bcc);

        const res = await fetch("{{ url_for('email.email_compose') }}", {
          method: "POST",
          body: fd,
        });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          throw new Error(data.error || "Failed to send email");
        }

        previewStatus.textContent = "Email sent successfully!";
        previewStatus.className = "text-sm font-medium text-green-600";
        setTimeout(() => {
          closePreviewModal();
        }, 1500);
      } catch (err) {
        previewStatus.textContent = "Error: " + (err.message || err);
        previewStatus.className = "text-sm font-medium text-red-600";
      } finally {
        previewSaveDraft.disabled = false;
        previewSend.disabled = false;
      }
    });
  });
</script>
{% endblock %}
