{% extends "base.html" %}
{% block title %}Orchestrator Chat{% endblock %}
{% block content %}
<div class="max-w-xl mx-auto mt-10">
  <h1 class="text-2xl font-semibold mb-4">Orchestrator Chat</h1>
  <div class="bg-white rounded-xl shadow p-4 mb-4">
    <form id="chat-form" enctype="multipart/form-data" class="flex flex-col gap-3">
      <textarea name="prompt" id="prompt" rows="2" class="border rounded p-2" placeholder="Type your prompt..."></textarea>
      <div class="flex items-center gap-2">
        <input type="file" name="file" id="file" accept="application/pdf" class="hidden">
        <button type="button" id="attach-btn" class="px-3 py-1 rounded border bg-gray-100 hover:bg-gray-200 text-sm">Attach PDF</button>
        <span id="file-pill" class="hidden px-2 py-1 rounded bg-indigo-100 text-indigo-800 text-xs font-medium">
          <span id="file-name"></span>
          <button type="button" id="remove-file" class="ml-1 text-indigo-600 hover:text-red-600">&times;</button>
        </span>
      </div>
      <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Send</button>
    </form>
  </div>
  <div class="bg-white rounded-xl shadow p-4">
    <div id="chat-messages" class="flex flex-col gap-3"></div>
  </div>
</div>
<script>
const form = document.getElementById('chat-form');
const promptEl = document.getElementById('prompt');
const fileInput = document.getElementById('file');
const attachBtn = document.getElementById('attach-btn');
const filePill = document.getElementById('file-pill');
const fileNameSpan = document.getElementById('file-name');
const removeFileBtn = document.getElementById('remove-file');
const chatMessages = document.getElementById('chat-messages');
let attachedFile = null;

attachBtn.onclick = () => fileInput.click();
fileInput.onchange = () => {
  if (fileInput.files.length > 0) {
    attachedFile = fileInput.files[0];
    fileNameSpan.textContent = attachedFile.name;
    filePill.classList.remove('hidden');
  }
};
removeFileBtn.onclick = () => {
  attachedFile = null;
  fileInput.value = '';
  filePill.classList.add('hidden');
};

form.onsubmit = async (e) => {
  e.preventDefault();
  const prompt = promptEl.value.trim();
  if (!prompt) return;
  const fd = new FormData();
  fd.append('prompt', prompt);
  if (attachedFile) fd.append('file', attachedFile);
  // Show user message
  addMsg(prompt, 'user');
  promptEl.value = '';
  attachedFile = null;
  fileInput.value = '';
  filePill.classList.add('hidden');
  // Send to backend
  const res = await fetch('/api/chat', { method: 'POST', body: fd });
  const data = await res.json();
  if (data.assistant_markdown) {
    addMsg(data.assistant_markdown, 'assistant', true);
  } else if (data.error) {
    addMsg(data.error, 'error');
  } else {
    addMsg('No response', 'error');
  }
};

function addMsg(text, who, isMarkdown=false) {
  const div = document.createElement('div');
  div.className = who === 'user' ? 'self-end bg-indigo-50 text-indigo-900 px-3 py-2 rounded-lg max-w-[80%]' :
    who === 'assistant' ? 'self-start bg-gray-50 text-gray-900 px-3 py-2 rounded-lg max-w-[80%] prose prose-sm' :
    'self-center text-red-600 px-3 py-2';
  if (isMarkdown && window.marked && window.DOMPurify) {
    div.innerHTML = DOMPurify.sanitize(marked.parse(text));
  } else {
    div.textContent = text;
  }
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
</script>
{% endblock %}
