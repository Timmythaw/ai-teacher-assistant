<!-- {% extends "base.html" %}
{% block title %}Orchestrator Chat{% endblock %}
{% block content %}
<div class="max-w-3xl mx-auto">
  <h1 class="text-2xl font-semibold mb-4">Orchestrator Chat</h1>

  <div class="bg-white rounded-xl shadow p-4 mb-4">
    <form id="chat-form" class="space-y-3" enctype="multipart/form-data">
      <div>
        <label class="block text-sm font-medium mb-1">Your prompt</label>
        <textarea name="prompt" id="prompt" rows="3" class="w-full border rounded p-2" placeholder="e.g., Create a lesson plan and timetable or Generate an assessment from a lecture PDF"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Optional file (.pdf)</label>
        <input type="file" name="file" id="file" accept="application/pdf" class="w-full">
        <p class="text-xs text-gray-500 mt-1">Upload a course outline or lecture PDF if your prompt requires it.</p>
      </div>
      <div class="flex gap-2">
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Run</button>
        <button type="button" id="btn-resume" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 disabled:opacity-50" disabled>Resume</button>
      </div>
    </form>
  </div>

  <div class="bg-white rounded-xl shadow p-4">
    <h2 class="text-lg font-medium mb-2">Output</h2>
    <div id="messages" class="space-y-2 text-sm"></div>
    <pre id="json" class="mt-3 p-3 bg-gray-50 rounded overflow-auto text-xs"></pre>
  </div>
</div>

<script>
  const form = document.getElementById('chat-form');
  const messages = document.getElementById('messages');
  const jsonEl = document.getElementById('json');
  const btnResume = document.getElementById('btn-resume');
  let lastState = null;

  function addMsg(text, type = 'info') {
    const div = document.createElement('div');
    div.className = type === 'error' ? 'text-red-600' : 'text-gray-800';
    div.textContent = text;
    messages.appendChild(div);
  }

  function showJSON(obj) {
    jsonEl.textContent = JSON.stringify(obj, null, 2);
  }

  async function callChatAPI(fd) {
    const res = await fetch('/api/chat', { method: 'POST', body: fd });
    const data = await res.json();
    return { status: res.status, data };
  }

  async function callContinueAPI(state) {
    const res = await fetch('/api/chat/continue', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ state }) });
    const data = await res.json();
    return { status: res.status, data };
  }

  function handleNeedResources(resp) {
    const reqs = resp.requirements || [];
    if (!reqs.length) return;
    addMsg(resp.message || 'Additional resources required.');
    // Surface requirements
    reqs.forEach(r => {
      addMsg(`Missing for ${r.flow}: ${r.label} (${r.accept})`, 'error');
    });
  }

  function updateResume(state) {
    lastState = state;
    const paused = state && state.state && state.state.status === 'paused';
    btnResume.disabled = !paused;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    messages.textContent = '';
    jsonEl.textContent = '';

    const fd = new FormData(form);
    const { status, data } = await callChatAPI(fd);
    if (!data.ok) {
      if (data.need_resources) {
        handleNeedResources(data);
      } else {
        addMsg(data.error || 'Request failed', 'error');
      }
      showJSON(data);
      return;
    }

    addMsg('Request accepted.');
    showJSON(data.summary || data);
    updateResume(data.state);
  });

  btnResume.addEventListener('click', async () => {
    if (!lastState) return;
    const { status, data } = await callContinueAPI(lastState);
    if (!data.ok) {
      addMsg(data.error || 'Resume failed', 'error');
      showJSON(data);
      return;
    }
    addMsg('Resumed.');
    showJSON(data.summary || data);
    updateResume(data.state);
  });
</script>
{% endblock %} -->
