{% extends "base.html" %} {% set breadcrumbs = [ {'label': 'Dashboard', 'url':
url_for('index')}, {'label': 'Generate Assessment', 'url': None} ] %} {% block
title %}Generate Assessment â€” AI Lesson Planner{% endblock %} {% block content
%}
<h1 class="text-xl font-semibold mb-4">Generate Assessment from PDF</h1>

<form id="upload-form" action="{{ url_for('generate_assessment') }}" method="post" enctype="multipart/form-data"
  class="max-w-2xl grid gap-4 bg-white border rounded-xl p-5">
  <!-- PDF Upload -->
  <div>
    <label for="pdf" class="block text-sm font-medium mb-1">Course PDF</label>
    <input id="pdf" name="pdf" type="file" accept="application/pdf" required
      class="block w-full text-sm file:mr-4 file:py-2 file:px-3 file:rounded-md file:border file:bg-gray-50 file:text-gray-700 border rounded-md p-1.5" />
  </div>

  <!-- Options -->
  <div class="grid sm:grid-cols-3 gap-4">
    <div>
      <label for="type" class="block text-sm font-medium mb-1">Type</label>
      <select id="type" name="type" class="w-full border rounded-md p-2">
        <option value="MCQ" selected>MCQ</option>
        <option value="ShortAnswer">ShortAnswer</option>
        <option value="Project">Project</option>
      </select>
    </div>

    <div>
      <label for="difficulty" class="block text-sm font-medium mb-1">Difficulty</label>
      <select id="difficulty" name="difficulty" class="w-full border rounded-md p-2">
        <option>Easy</option>
        <option selected>Medium</option>
        <option>Hard</option>
      </select>
    </div>

    <div>
      <label for="count" class="block text-sm font-medium mb-1">Questions</label>
      <input id="count" name="count" type="number" min="1" max="50" value="3" class="w-full border rounded-md p-2" />
    </div>
  </div>

  <!-- Rubric -->
  <label class="inline-flex items-center gap-2">
    <input id="rubric" name="rubric" type="checkbox" checked class="h-4 w-4" />
    <span class="text-sm">Include rubric</span>
  </label>

  <!-- <label class="inline-flex items-center gap-2">
    <input
      id="create_form"
      name="create_form"
      type="checkbox"
      class="h-4 w-4"
    />
    <span class="text-sm">Also create a Google Form</span>
  </label> -->

  <!-- Submit -->
  <div class="flex items-center gap-3">
    <button id="assessment-generate-btn" type="submit"
      class="px-4 py-2 rounded-md border bg-gray-900 text-white hover:bg-black disabled:opacity-50 disabled:cursor-not-allowed">
      Generate
    </button>

    <span id="save-status" class="text-xs text-gray-500"></span>

    <span class="text-xs text-gray-500">
      Preview will render below. Use Download to get a PDF.
    </span>
  </div>
</form>

<!-- Preview -->
<section id="result-wrapper" class="mt-4 hidden">
  <div class="flex items-center justify-between mb-2">
    <div class="text-sm text-gray-500">Preview</div>
    <div class="flex items-center gap-2">
      <button id="copy-md-btn" type="button"
        class="inline-flex items-center gap-2 px-3 py-1.5 text-sm rounded-md border hover:bg-gray-50"
        title="Copy Markdown">
        Copy Markdown
      </button>
      <button id="copy-plain-btn" type="button"
        class="inline-flex items-center gap-2 px-3 py-1.5 text-sm rounded-md border hover:bg-gray-50"
        title="Copy Visible Text">
        Copy Text
      </button>
      <button id="download-pdf-btn" type="button"
        class="inline-flex items-center gap-2 px-3 py-1.5 text-sm rounded-md border bg-gray-900 text-white hover:bg-black"
        title="Download as PDF">
        Download PDF
      </button>
      <button id="save-btn" type="button"
        class="inline-flex items-center gap-2 px-3 py-1.5 text-sm rounded-md border bg-emerald-600 text-white hover:bg-emerald-700 hidden"
        title="Save to database">
        Save
      </button>
    </div>
  </div>
  <article id="result" class="prose prose-slate max-w-none bg-white border rounded-xl p-6 shadow-sm"></article>
</section>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.2/dist/purify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("upload-form");
    const resultWrapper = document.getElementById("result-wrapper");
    const resultEl = document.getElementById("result");
    const copyMdBtn = document.getElementById("copy-md-btn");
    const copyPlainBtn = document.getElementById("copy-plain-btn");
    const downloadPdfBtn = document.getElementById("download-pdf-btn");
    const saveBtn = document.getElementById("save-btn");
    const saveStatus = document.getElementById("save-status");

    let lastMarkdown = "";
    let suggestedFileName = "assessment";
    let lastAssessmentObj = null;
    let lastOptions = null;
    let lastOriginalFilename = null;

    function jsonToMarkdownStrict(data) {
      if (!data || typeof data !== "object")
        return "### Error\n\nInvalid data.";
      const lines = [];
      const title = data.type
        ? `${data.type} Assessment`
        : "Generated Assessment";
      lines.push(`# ${title}`, "");
      if (data.difficulty) lines.push(`**Difficulty:** ${data.difficulty}`, "");
      if (Array.isArray(data.questions)) {
        data.questions.forEach((q, i) => {
          lines.push(`## Q${i + 1}. ${q.q || "Untitled Question"}`, "");
          if (Array.isArray(q.options) && q.options.length) {
            q.options.forEach((opt, j) => {
              const letter = String.fromCharCode(65 + j);
              lines.push(`- ${letter}. ${opt}`);
            });
            lines.push("");
          }
          if (q.answer != null) lines.push(`**Answer:** ${q.answer}`, "");
        });
      }
      if (Array.isArray(data.rubric) && data.rubric.length) {
        lines.push("## Rubric", "");
        data.rubric.forEach((r) =>
          lines.push(`- ${r.criteria || "Criteria"} (${r.points ?? 0} pts)`)
        );
        lines.push("");
      }
      return lines.join("\n").trim();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // ðŸ”¹ Disable the Generate button
      const generateBtn = document.getElementById("assessment-generate-btn");
      generateBtn.disabled = true;
      const originalBtnText = generateBtn.textContent;
      generateBtn.textContent = "Generating...";

      resultWrapper.classList.add("hidden");
      resultEl.innerHTML = "";
      lastMarkdown = "";
      lastAssessmentObj = null;
      saveStatus.textContent = "";
      saveBtn.classList.add("hidden");

      suggestedFileName = "assessment";
      const pdfInput = document.getElementById("pdf");
      if (pdfInput?.files && pdfInput.files[0]) {
        const base = pdfInput.files[0].name.replace(/\.[^.]+$/, "");
        suggestedFileName = `assessment_${base}`;
        lastOriginalFilename = pdfInput.files[0].name;
      } else {
        lastOriginalFilename = null;
      }

      lastOptions = {
        type: document.getElementById("type")?.value || "MCQ",
        difficulty: document.getElementById("difficulty")?.value || "Medium",
        count: parseInt(document.getElementById("count")?.value || "5", 10),
        rubric: !!document.getElementById("rubric")?.checked,
      };

      try {
        const res = await fetch(form.getAttribute("action"), {
          method: "POST",
          body: new FormData(form),
        });
        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errText}`);
        }

    const ct = res.headers.get("Content-Type") || "";
        let md = "";
        if (ct.includes("application/json")) {
          const assessment = await res.json(); // server returns the assessment object directly
          if (assessment.error) {
            md = `### Error\n\n${assessment.error}`;
            suggestedFileName = "assessment_error";
          } else {
      lastAssessmentObj = assessment;
      // Prefer server-rendered markdown if present
      md = assessment._markdown || jsonToMarkdownStrict(assessment);
          }
        } else {
          md = await res.text();
        }

        lastMarkdown = md;
        resultEl.innerHTML = DOMPurify.sanitize(marked.parse(md));
        resultWrapper.classList.remove("hidden");
        resultWrapper.scrollIntoView({ behavior: "smooth", block: "start" });

        if (lastAssessmentObj && Array.isArray(lastAssessmentObj.questions)) {
          saveBtn.classList.remove("hidden");
        }
      } catch (err) {
        lastMarkdown = `### Error\n\n${err.message}`;
        resultEl.innerText = lastMarkdown;
        resultWrapper.classList.remove("hidden");
      } finally {
        // ðŸ”¹ Restore button
        generateBtn.disabled = false;
        generateBtn.textContent = originalBtnText;
      }
    });

    // Save to DB (Supabase) via your Flask API
    saveBtn.addEventListener("click", async () => {
      if (!lastAssessmentObj) return;
      saveBtn.disabled = true;
      saveStatus.textContent = "Saving...";
    try {
        const payload = {
          original_filename: lastOriginalFilename,
          pdf_path: null, // optional; fill if your server returns a path
          options: lastOptions,
      // Store pure JSON only (drop any server-provided preview helpers)
      result: (() => { const c = JSON.parse(JSON.stringify(lastAssessmentObj || {})); delete c._markdown; return c; })(),
          google_form: null, // we create this later in the table UI
        };
        const resp = await fetch("/api/assessments", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await resp.json();
        if (!resp.ok || !data.ok)
          throw new Error(data.error || `HTTP ${resp.status}`);
        saveStatus.textContent = `Saved! id=${data.id}`;
      } catch (e) {
        saveStatus.textContent = `Save failed: ${e.message}`;
      } finally {
        saveBtn.disabled = false;
      }
    });

    // Copy buttons
    async function copyWithFeedback(btnEl, text) {
      const original = btnEl.innerText;
      try {
        await navigator.clipboard.writeText(text);
        btnEl.innerText = "Copied!";
        btnEl.classList.add(
          "bg-emerald-50",
          "border-emerald-300",
          "text-emerald-800"
        );
        setTimeout(() => {
          btnEl.innerText = original;
          btnEl.classList.remove(
            "bg-emerald-50",
            "border-emerald-300",
            "text-emerald-800"
          );
        }, 1200);
      } catch {
        btnEl.innerText = "Failed";
        btnEl.classList.add("bg-red-50", "border-red-300", "text-red-800");
        setTimeout(() => {
          btnEl.innerText = original;
          btnEl.classList.remove("bg-red-50", "border-red-300", "text-red-800");
        }, 1400);
      }
    }
    copyMdBtn.addEventListener("click", () =>
      copyWithFeedback(copyMdBtn, lastMarkdown || resultEl.innerText.trim())
    );
    copyPlainBtn.addEventListener("click", () =>
      copyWithFeedback(copyPlainBtn, resultEl.innerText.trim())
    );

    // PDF Download
    downloadPdfBtn.addEventListener("click", () => {
      if (typeof html2pdf === "undefined") {
        alert("PDF generator not loaded yet. Please try again in a moment.");
        return;
      }
      const opt = {
        margin: [15, 15, 15, 15],
        filename: `${suggestedFileName}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
      };
      const preview = resultEl.cloneNode(true);
      preview.className = "prose prose-slate";
      preview.style.cssText = `
      background-color: #ffffff !important;
      border: none !important;
      border-radius: 0 !important;
      box-shadow: none !important;
      padding: 0 !important;
      margin: 0 !important;
      max-width: 100% !important;
      width: 100% !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      line-height: 1.6;
      color: #000000;
    `;
      html2pdf().set(opt).from(preview).save();
    });
  });
</script>

{% endblock %}