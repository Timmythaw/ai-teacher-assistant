{% extends "base.html" %}
{% block title %}Courses & Batches{% endblock %}
{% block content %}

<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
  <div>
    <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Batches</h1>
    <p class="text-sm text-slate-500 mt-1">
      Manage your student groups and course rosters.
    </p>
  </div>

  <button
    id="open-create"
    class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-all duration-200 hover:-translate-y-0.5 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
  >
    <svg
      class="w-5 h-5 mr-2 -ml-1"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M12 4.5v15m7.5-7.5h-15"
      />
    </svg>
    Create New Batch
  </button>
</div>


{% if batches and batches|length > 0 %}
<div
  class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden transition-shadow duration-200 hover:shadow-md"
>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-slate-100">
      <thead class="bg-slate-50/90">
        <tr>
          <th
            scope="col"
            class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider"
          >
            Batch Name
          </th>
          <th
            scope="col"
            class="px-6 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider"
          >
            Students
          </th>
          <th scope="col" class="relative px-6 py-3">
            <span class="sr-only">Actions</span>
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-slate-100">
        {% for batch in batches %}
          {% set count = 0 %}
          {% if batch.students and batch.students|length > 0 %}
            {% set count = batch.students[0].count or 0 %}
          {% endif %}

        <tr class="group transition-all duration-150 hover:bg-slate-50/80">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div
                class="flex-shrink-0 h-8 w-8 rounded bg-indigo-50 text-indigo-600 flex items-center justify-center mr-3 border border-indigo-100 group-hover:shadow-sm transition-shadow duration-150"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"
                  />
                </svg>
              </div>
              <div>
                <div
                  class="text-sm font-medium text-slate-900 group-hover:text-blue-600 transition-colors"
                >
                  {{ batch.name or 'Untitled Batch' }}
                </div>
                {% if batch.created_at %}
                <div class="text-xs text-slate-500">
                  Created: {{ batch.created_at }}
                </div>
                {% endif %}
              </div>
            </div>
          </td>

          <td class="px-6 py-4 whitespace-nowrap text-center">
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800 group-hover:bg-blue-50 group-hover:text-blue-700 transition-colors"
            >
              {{ count }} students
            </span>
          </td>

          <td
            class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"
          >
            <div class="flex items-center justify-end gap-2">
              <a
                href="{{ url_for('batches.batch_show', batch_id=batch.id) }}"
                class="inline-flex items-center px-3 py-1.5 border border-slate-300 shadow-sm text-xs font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all"
              >
                <svg
                  class="w-3 h-3 mr-1.5 text-slate-500"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                View Students
              </a>
              <button
                type="button"
                data-url="{{ url_for('batches.api_delete_batch', batch_id=batch.id) }}"
                class="delete-batch inline-flex items-center px-3 py-1.5 border border-red-300 shadow-sm text-xs font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none"
              >
                <svg
                  class="w-3 h-3 mr-1.5 text-red-500"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7V4a1 1 0 011-1h4a1 1 0 011 1v3"
                  />
                </svg>
                Delete
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div
  class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"
>
  <div class="flex flex-col items-center justify-center py-16 text-center">
    <div
      class="h-16 w-16 bg-slate-50 rounded-full flex items-center justify-center mb-4"
    >
      <svg
        class="w-8 h-8 text-slate-300"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"
        />
      </svg>
    </div>
    <h3 class="text-sm font-medium text-slate-900">No batches created</h3>
    <p class="mt-1 text-sm text-slate-500 mb-6">
      Get started by creating a new batch.
    </p>
    <button
      onclick="document.getElementById('open-create').click()"
      class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
    >
      Create Batch
    </button>
  </div>
</div>
{% endif %}

{# -------------- CREATE / EDIT MODAL -------------- #}
<div
  id="create-modal"
  class="fixed inset-0 z-50 hidden"
  role="dialog"
  aria-modal="true"
>
  <div
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"
  ></div>

  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div
      class="flex min-h-full items-center justify-center p-4 text-center sm:p-0"
    >
      <div
        class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-slate-200"
      >
        <div
          class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex items-center justify-between"
        >
          <h3 class="text-base font-semibold leading-6 text-slate-800" id="modal-title">
            Create New Batch
          </h3>
          <button
            id="close-create"
            class="text-slate-400 hover:text-slate-600 rounded-md p-1 hover:bg-slate-200 transition-colors"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <!-- STEP 1: Choose Input Method -->
        <div id="step-choose-method" class="p-6">
          <p class="text-sm text-slate-600 mb-4">
            Choose how you'd like to add students to this batch:
          </p>
          
          <div class="grid grid-cols-1 gap-4">
            <!-- CSV Upload Option -->
            <button
              type="button"
              id="choose-csv"
              class="group relative flex items-start p-5 border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50/30 transition-all duration-200 text-left focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              <div class="flex-shrink-0 mt-0.5">
                <div class="w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                  </svg>
                </div>
              </div>
              <div class="ml-4 flex-1">
                <div class="font-semibold text-slate-900 text-base mb-1">Upload CSV File</div>
                <p class="text-sm text-slate-600">
                  Import multiple students at once from a CSV file containing name and email columns.
                </p>
              </div>
              <div class="flex-shrink-0 ml-3 text-slate-400 group-hover:text-blue-500 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
              </div>
            </button>

            <!-- Manual Input Option -->
            <button
              type="button"
              id="choose-manual"
              class="group relative flex items-start p-5 border-2 border-slate-200 rounded-xl hover:border-green-500 hover:bg-green-50/30 transition-all duration-200 text-left focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
            >
              <div class="flex-shrink-0 mt-0.5">
                <div class="w-10 h-10 rounded-lg bg-green-100 text-green-600 flex items-center justify-center group-hover:bg-green-200 transition-colors">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                  </svg>
                </div>
              </div>
              <div class="ml-4 flex-1">
                <div class="font-semibold text-slate-900 text-base mb-1">Add Manually</div>
                <p class="text-sm text-slate-600">
                  Enter student names and emails one by one through a simple form.
                </p>
              </div>
              <div class="flex-shrink-0 ml-3 text-slate-400 group-hover:text-green-500 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
              </div>
            </button>
          </div>
        </div>

        <!-- STEP 2: CSV Upload Form -->
        <form
          id="csv-form"
          class="p-6 space-y-4 hidden"
          enctype="multipart/form-data"
        >
          <div>
            <label
              class="block text-sm font-medium text-slate-700 mb-1"
              for="batch_name_csv"
              >Batch Name</label
            >
            <input
              id="batch_name_csv"
              name="batch_name"
              type="text"
              required
              placeholder="e.g., CS101 - Fall 2025"
              class="block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-2.5 px-2 sm:text-base"
            />
          </div>

          <div>
            <label
              class="block text-sm font-medium text-slate-700 mb-1"
              for="students_csv"
              >Upload Students (CSV)</label
            >
            <input
              id="students_csv"
              name="students_csv"
              type="file"
              accept=".csv"
              required
              class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            />
            <p class="text-xs text-slate-500 mt-2 flex items-center gap-1">
              <svg
                class="w-4 h-4 text-slate-400"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"
                />
              </svg>
              CSV must include columns
              <span class="font-mono bg-slate-100 px-1 rounded text-slate-600"
                >name</span
              >
              and
              <span class="font-mono bg-slate-100 px-1 rounded text-slate-600"
                >email</span
              >.
            </p>
          </div>

          <div
            id="csv-status"
            class="text-xs font-medium text-blue-600"
          ></div>

          <div
            class="flex items-center justify-between pt-4 border-t border-slate-100 mt-2"
          >
            <button
              type="button"
              id="back-from-csv"
              class="inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-slate-700 hover:text-slate-900 transition-colors"
            >
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
              </svg>
              Back
            </button>
            <div class="flex items-center gap-3">
              <button
                type="button"
                id="cancel-csv"
                class="inline-flex items-center justify-center px-4 py-2 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                Cancel
              </button>
              <button
                type="submit"
                id="submit-csv"
                class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                Create Batch
              </button>
            </div>
          </div>
        </form>

        <!-- STEP 3: Manual Input Form -->
        <form
          id="manual-form"
          class="p-6 space-y-4 hidden"
        >
          <div>
            <label
              class="block text-sm font-medium text-slate-700 mb-1"
              for="batch_name_manual"
              >Batch Name</label
            >
            <input
              id="batch_name_manual"
              name="batch_name"
              type="text"
              required
              placeholder="e.g., CS101 - Fall 2025"
              class="block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-2.5 px-2 sm:text-base"
            />
          </div>

          <div class="border-t border-slate-100 pt-4">
            <label class="block text-sm font-medium text-slate-700 mb-3"
              >Add Students</label
            >

            <div class="grid grid-cols-2 gap-2 mb-2">
              <input
                id="manual_name"
                placeholder="Student name"
                type="text"
                class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-2.5 sm:text-base"
              />
              <input
                id="manual_email"
                placeholder="Student email"
                type="email"
                class="block w-full rounded-md px-1.5 border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-2.5 sm:text-base"
              />
            </div>

            <button
              type="button"
              id="add-student"
              class="inline-flex items-center px-3 py-1.5 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 mb-3"
            >
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
              Add Student
            </button>

            <div id="manual-students-list" class="space-y-2">
              <!-- dynamic student items appear here -->
            </div>

            <p class="text-xs text-slate-500 mt-3" id="manual-count">
              No students added yet.
            </p>
          </div>

          <div
            id="manual-status"
            class="text-xs font-medium text-blue-600"
          ></div>

          <div
            class="flex items-center justify-between pt-4 border-t border-slate-100 mt-2"
          >
            <button
              type="button"
              id="back-from-manual"
              class="inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-slate-700 hover:text-slate-900 transition-colors"
            >
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
              </svg>
              Back
            </button>
            <div class="flex items-center gap-3">
              <button
                type="button"
                id="cancel-manual"
                class="inline-flex items-center justify-center px-4 py-2 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                Cancel
              </button>
              <button
                type="submit"
                id="submit-manual"
                class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                Create Batch
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("create-modal");
    const modalTitle = document.getElementById("modal-title");
    const openBtn = document.getElementById("open-create");
    const closeBtn = document.getElementById("close-create");
    
    // Step elements
    const stepChooseMethod = document.getElementById("step-choose-method");
    const csvForm = document.getElementById("csv-form");
    const manualForm = document.getElementById("manual-form");
    
    // Method choice buttons
    const chooseCsvBtn = document.getElementById("choose-csv");
    const chooseManualBtn = document.getElementById("choose-manual");
    
    // CSV form elements
    const csvStatusEl = document.getElementById("csv-status");
    const submitCsvBtn = document.getElementById("submit-csv");
    const cancelCsvBtn = document.getElementById("cancel-csv");
    const backFromCsvBtn = document.getElementById("back-from-csv");
    const csvInput = document.getElementById("students_csv");
    const batchNameCsv = document.getElementById("batch_name_csv");
    
    // Manual form elements
    const manualStatusEl = document.getElementById("manual-status");
    const submitManualBtn = document.getElementById("submit-manual");
    const cancelManualBtn = document.getElementById("cancel-manual");
    const backFromManualBtn = document.getElementById("back-from-manual");
    const addStudentBtn = document.getElementById("add-student");
    const manualNameInput = document.getElementById("manual_name");
    const manualEmailInput = document.getElementById("manual_email");
    const manualListEl = document.getElementById("manual-students-list");
    const manualCountEl = document.getElementById("manual-count");
    const batchNameManual = document.getElementById("batch_name_manual");

    let manualStudents = [];

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function renderManualList() {
      manualListEl.innerHTML = "";
      manualStudents.forEach((s, i) => {
        const item = document.createElement("div");
        item.className =
          "flex items-center justify-between gap-3 px-3 py-2 rounded border border-slate-200 bg-slate-50";
        item.innerHTML = `
          <div class="text-sm">
            <div class="font-medium text-slate-900">${escapeHtml(s.name)}</div>
            <div class="text-xs text-slate-500">${escapeHtml(s.email)}</div>
          </div>
          <div class="flex items-center gap-2">
            <button type="button" data-index="${i}" class="remove-student inline-flex items-center px-2 py-1 border border-red-200 text-xs rounded-md text-red-600 bg-red-50 hover:bg-red-100 transition-colors">Remove</button>
          </div>
        `;
        manualListEl.appendChild(item);
      });

      manualListEl.querySelectorAll(".remove-student").forEach((btn) => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.getAttribute("data-index"));
          manualStudents.splice(idx, 1);
          renderManualList();
        });
      });

      // Update count
      if (manualStudents.length === 0) {
        manualCountEl.textContent = "No students added yet.";
        manualCountEl.className = "text-xs text-slate-500 mt-3";
      } else {
        manualCountEl.textContent = `${manualStudents.length} student${manualStudents.length === 1 ? '' : 's'} added.`;
        manualCountEl.className = "text-xs text-green-600 font-medium mt-3";
      }
    }

    function showStep(step) {
      stepChooseMethod.classList.add("hidden");
      csvForm.classList.add("hidden");
      manualForm.classList.add("hidden");

      if (step === "choose") {
        modalTitle.textContent = "Create New Batch";
        stepChooseMethod.classList.remove("hidden");
      } else if (step === "csv") {
        modalTitle.textContent = "Create Batch - Upload CSV";
        csvForm.classList.remove("hidden");
      } else if (step === "manual") {
        modalTitle.textContent = "Create Batch - Add Manually";
        manualForm.classList.remove("hidden");
      }
    }

    function openModal() {
      // Reset all forms
      csvForm.reset();
      manualForm.reset();
      manualStudents = [];
      renderManualList();
      csvStatusEl.textContent = "";
      manualStatusEl.textContent = "";
      
      // Show step 1
      showStep("choose");
      modal.classList.remove("hidden");
    }

    function closeModal() {
      modal.classList.add("hidden");
    }

    // Open modal
    if (openBtn) openBtn.addEventListener("click", openModal);
    if (closeBtn) closeBtn.addEventListener("click", closeModal);

    // Close when clicking backdrop
    modal.addEventListener("click", (e) => {
      const panel = e.target.closest(".bg-white");
      if (!panel) {
        closeModal();
      }
    });

    // Method selection
    if (chooseCsvBtn) {
      chooseCsvBtn.addEventListener("click", () => {
        showStep("csv");
        setTimeout(() => batchNameCsv.focus(), 50);
      });
    }

    if (chooseManualBtn) {
      chooseManualBtn.addEventListener("click", () => {
        showStep("manual");
        setTimeout(() => batchNameManual.focus(), 50);
      });
    }

    // Back buttons
    if (backFromCsvBtn) {
      backFromCsvBtn.addEventListener("click", () => showStep("choose"));
    }

    if (backFromManualBtn) {
      backFromManualBtn.addEventListener("click", () => showStep("choose"));
    }

    // Cancel buttons
    if (cancelCsvBtn) cancelCsvBtn.addEventListener("click", closeModal);
    if (cancelManualBtn) cancelManualBtn.addEventListener("click", closeModal);

    // CSV Form Submit
    csvForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const hasFile = csvInput && csvInput.files && csvInput.files.length > 0;
      if (!hasFile) {
        csvStatusEl.textContent = "Please select a CSV file.";
        csvStatusEl.className = "text-xs font-medium text-red-600";
        return;
      }

      csvStatusEl.textContent = "Uploading and creating batch...";
      csvStatusEl.className = "text-xs font-medium text-blue-600 animate-pulse";
      submitCsvBtn.disabled = true;
      submitCsvBtn.classList.add("opacity-50", "cursor-not-allowed");

      try {
        const fd = new FormData(csvForm);

        const res = await fetch(
          "{{ url_for('batches.create_batch_upload_csv') }}",
          {
            method: "POST",
            credentials: "same-origin",
            body: fd,
          }
        );

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Failed (${res.status}). ${text.slice(0, 200)}`);
        }

        csvStatusEl.textContent = "Success! Reloading...";
        csvStatusEl.className = "text-xs font-medium text-green-600";
        setTimeout(() => {
          location.reload();
        }, 500);
      } catch (err) {
        csvStatusEl.textContent = "Error: " + (err.message || err);
        csvStatusEl.className = "text-xs font-medium text-red-600";
        submitCsvBtn.disabled = false;
        submitCsvBtn.classList.remove("opacity-50", "cursor-not-allowed");
      }
    });

    // Add student button
    if (addStudentBtn) {
      addStudentBtn.addEventListener("click", () => {
        const name = (manualNameInput.value || "").trim();
        const email = (manualEmailInput.value || "").trim();
        if (!name) {
          alert("Please enter student name.");
          manualNameInput.focus();
          return;
        }
        if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
          alert("Please enter a valid email address.");
          manualEmailInput.focus();
          return;
        }

        manualStudents.push({ name, email });
        manualNameInput.value = "";
        manualEmailInput.value = "";
        manualNameInput.focus();
        renderManualList();
      });
    }

    // Manual Form Submit
    manualForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (manualStudents.length === 0) {
        manualStatusEl.textContent = "Please add at least one student.";
        manualStatusEl.className = "text-xs font-medium text-red-600";
        return;
      }

      manualStatusEl.textContent = "Creating batch...";
      manualStatusEl.className = "text-xs font-medium text-blue-600 animate-pulse";
      submitManualBtn.disabled = true;
      submitManualBtn.classList.add("opacity-50", "cursor-not-allowed");

      try {
        const payload = {
          batch_name: batchNameManual.value,
          students_manual: manualStudents,
        };

        const res = await fetch(
          "{{ url_for('batches.create_batch_upload_csv') }}",
          {
            method: "POST",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }
        );

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Failed (${res.status}). ${text.slice(0, 200)}`);
        }

        manualStatusEl.textContent = "Success! Reloading...";
        manualStatusEl.className = "text-xs font-medium text-green-600";
        setTimeout(() => {
          location.reload();
        }, 500);
      } catch (err) {
        manualStatusEl.textContent = "Error: " + (err.message || err);
        manualStatusEl.className = "text-xs font-medium text-red-600";
        submitManualBtn.disabled = false;
        submitManualBtn.classList.remove("opacity-50", "cursor-not-allowed");
      }
    });

    // Delete batch handlers
    document.querySelectorAll(".delete-batch").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const url = btn.getAttribute("data-url");
        if (!url) return;

        const ok = confirm(
          "Delete this batch and all its students? This action cannot be undone."
        );
        if (!ok) return;

        try {
          btn.disabled = true;
          const res = await fetch(url, {
            method: "DELETE",
            credentials: "same-origin",
          });
          if (!res.ok) {
            const json = await res.json().catch(() => null);
            const err =
              json && json.error ? json.error : `Failed (${res.status})`;
            alert("Delete failed: " + err);
            btn.disabled = false;
            return;
          }
          location.reload();
        } catch (err) {
          alert("Delete failed: " + (err && err.message ? err.message : err));
          btn.disabled = false;
        }
      });
    });
  });
</script>
{% endblock %}

