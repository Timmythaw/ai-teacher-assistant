{% extends "base.html" %} {% block title %}Courses & Batches{% endblock %} {%
block content %}

<div class="flex items-center justify-between mb-8">
  <div>
    <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Batches</h1>
    <p class="text-sm text-slate-500 mt-1">
      Manage your student groups and course rosters.
    </p>
  </div>

  <button id="open-create" class="btn-primary">
    <!-- <svg
      class="w-5 h-5 mr-2 -ml-1"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M12 4.5v15m7.5-7.5h-15"
      />
    </svg> -->
    Create New Batch
  </button>
</div>

<!-- <div class="flex items-center justify-between mb-6">
    <h2 class="text-lg font-semibold text-slate-800">Batches</h2>
    <span
      class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-slate-100 text-slate-600 border border-slate-200"
    >
      {{ (batches|length) or 0 }} Total
    </span>
  </div> -->

{% if batches and batches|length > 0 %}
<div class="table-container overflow-x-auto">
  <div class="min-w-full">
    <!-- Table header -->
    <div
      class="grid grid-cols-12 items-center text-sm text-white font-semibold rounded-t-lg overflow-hidden"
      style="background: #2d3748"
    >
      <div class="col-span-6 px-6 py-3">Batch Name</div>
      <div class="col-span-3 px-6 text-center py-3">Students</div>
      <div class="col-span-3 px-6 py-3">Actions</div>
    </div>

    <!-- Table rows -->
    <div class="divide-y">
      {% for batch in batches %} {% set count = 0 %} {% if batch.students and
      batch.students|length > 0 %} {% set count = batch.students[0].count or 0
      %} {% endif %}

      <div class="grid grid-cols-12 items-center bg-white px-6 py-4">
        <div class="col-span-6">
          <div class="text-sm font-medium text-slate-800">
            {{ batch.name or 'Untitled Batch' }}
          </div>
          {% if batch.created_at %}
          <div class="text-xs text-slate-400">
            Created: {{ batch.created_at }}
          </div>
          {% endif %}
        </div>

        <div class="col-span-3 text-center text-slate-500">
          <div class="text-sm">{{ count }}</div>
        </div>

        <div class="col-span-3 flex items-center gap-3">
          <a
            href="#"
            class="inline-flex items-center quick-action-btn px-4 py-2 rounded-md text-sm"
            >Assign Assignment</a
          >
          <a
            href="{{ url_for('batches.batch_show', batch_id=batch.id) }}"
            class="btn-secondary px-3 py-2 text-sm"
            >View</a
          >
          <!-- Delete action removed from UI until backend endpoint is ready -->
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% else %}
<div class="flex flex-col items-center justify-center py-12 text-center">
  <div
    class="h-16 w-16 bg-slate-50 rounded-full flex items-center justify-center mb-4"
  >
    <svg
      class="w-8 h-8 text-slate-300"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"
      />
    </svg>
  </div>
  <h3 class="text-sm font-medium text-slate-900">No batches created</h3>
  <p class="mt-1 text-sm text-slate-500">
    Get started by creating a new batch.
  </p>
</div>
{% endif %}

<div
  id="create-modal"
  class="fixed inset-0 z-50 hidden"
  role="dialog"
  aria-modal="true"
>
  <div
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"
  ></div>

  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div
      class="flex min-h-full items-center justify-center p-4 text-center sm:p-0"
    >
      <div
        class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-slate-200"
      >
        <div
          class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex items-center justify-between"
        >
          <h3 class="text-base font-semibold leading-6 text-slate-800">
            Create New Batch
          </h3>
          <button
            id="close-create"
            class="text-slate-400 hover:text-slate-600 rounded-md p-1 hover:bg-slate-200 transition-colors"
            aria-label="Close"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <form
          id="create-form"
          class="p-6 space-y-4"
          enctype="multipart/form-data"
        >
          <div>
            <label
              class="block text-sm font-medium text-slate-700 mb-1"
              for="batch_name"
              >Batch Name</label
            >
            <input
              id="batch_name"
              name="batch_name"
              type="text"
              required
              placeholder="e.g., CS101 - Fall 2025"
              class="block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
            />
          </div>

          <div>
            <label
              class="block text-sm font-medium text-slate-700 mb-1"
              for="students_csv"
              >Upload Students (CSV)</label
            >
            <input
              id="students_csv"
              name="students_csv"
              type="file"
              accept=".csv"
              required
              class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            />
            <p class="text-xs text-slate-500 mt-2 flex items-center gap-1">
              <svg
                class="w-4 h-4 text-slate-400"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"
                />
              </svg>
              CSV must include columns
              <span class="font-mono bg-slate-100 px-1 rounded text-slate-600"
                >name</span
              >
              and
              <span class="font-mono bg-slate-100 px-1 rounded text-slate-600"
                >email</span
              >.
            </p>
          </div>

          <div
            id="create-status"
            class="text-xs font-medium text-blue-600"
          ></div>

          <div
            class="flex items-center justify-end gap-3 pt-4 border-t border-slate-100 mt-2"
          >
            <button
              type="button"
              id="cancel-create"
              class="inline-flex items-center justify-center px-4 py-2 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Cancel
            </button>
            <button
              type="submit"
              id="submit-create"
              class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Create Batch
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("create-modal");
    const openBtn = document.getElementById("open-create");
    const closeBtn = document.getElementById("close-create");
    const cancelBtn = document.getElementById("cancel-create");
    const form = document.getElementById("create-form");
    const statusEl = document.getElementById("create-status");
    const submitBtn = document.getElementById("submit-create");

    function openModal() {
      form.reset();
      statusEl.textContent = "";
      modal.classList.remove("hidden");
    }
    function closeModal() {
      modal.classList.add("hidden");
      statusEl.textContent = "";
    }

    if (openBtn) openBtn.addEventListener("click", openModal);
    if (closeBtn) closeBtn.addEventListener("click", closeModal);
    if (cancelBtn) cancelBtn.addEventListener("click", closeModal);

    // Close when clicking backdrop
    modal.addEventListener("click", (e) => {
      // The modal container inside is technically the 'target' if clicked directly
      // but often clicks bubble. We want to close if the user clicks the
      // grey backdrop, not the white panel.
      // The backdrop is covered by the .fixed.inset-0 flex container.
      // We need to check if the click target is the overlay container.
      const overlay = modal.querySelector(".fixed.inset-0.z-10");
      if (
        e.target === overlay ||
        e.target.classList.contains("backdrop-blur-sm")
      ) {
        // This is a bit tricky with nested divs, simpler check:
        // If the closest .bg-white panel wasn't clicked
        if (!e.target.closest(".bg-white")) {
          closeModal();
        }
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusEl.textContent = "Uploading and creating batch...";
      statusEl.className = "text-xs font-medium text-blue-600 animate-pulse";
      submitBtn.disabled = true;
      submitBtn.classList.add("opacity-50", "cursor-not-allowed");

      try {
        const fd = new FormData(form);
        const res = await fetch(
          "{{ url_for('batches.create_batch_upload_csv') }}",
          {
            method: "POST",
            body: fd,
          }
        );

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Failed (${res.status}). ${text.slice(0, 200)}`);
        }

        statusEl.textContent = "Success! Reloading...";
        statusEl.className = "text-xs font-medium text-green-600";
        setTimeout(() => {
          location.reload();
        }, 500);
      } catch (err) {
        statusEl.textContent = "Error: " + (err.message || err);
        statusEl.className = "text-xs font-medium text-red-600";
        submitBtn.disabled = false;
        submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
      }
    });
  });
</script>
{% endblock %}
